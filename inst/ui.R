shiny::fluidPage(theme = "metaboshiny.css",class="hidden",id="metshi",
                 ECharts2Shiny::loadEChartsLibrary(),
                 shinyalert::useShinyalert(), 
                 shinyjs::useShinyjs(),
                 shiny::navbarPage(windowTitle='MetaboShiny',
                                   header=shiny::tagList(shiny::tags$script(src="spinnytitle.js"),
                                                         shiny::tags$script(src="sparkle.js")),
                                   # use this for title
                                   # https://codepen.io/maxspeicher/pen/zrVKLE
                                   title=shiny::div(shiny::h1("MetaboShiny"), 
                                                    class="outlined", 
                                                    id="sparkley"), # make it use the sparkle.js for unnecessary sparkle effects ;)
                                   id="nav_general",
                                   # this tab shows the available databases, if they are installed, and buttons to install them. generated as output$db_build_ui in 'server'
                                   shiny::tabPanel("database", icon = shiny::icon("database",class = "outlined"), value="database",
                                                   shiny::fluidRow(align="center", shinyBS::bsCollapse(shinyBS::bsCollapsePanel(title=shiny::h2("Settings"), style="info",
                                                                                                                                shiny::sliderInput(inputId = "db_mz_range", label = "What mass range can your machine detect?",
                                                                                                                                                   min = 0, max = 3000, value = c(60, 600),
                                                                                                                                                   step = 1,post = "m/z",dragRange = TRUE),
                                                                                                                                shiny::tags$i("Warning: increasing the upper m/z boundary may drastically increase database build times
                                                                                     - calculating isotopes is more time-consuming for larger molecules!"),
                                                                                                                                shiny::radioButtons("db_build_mode", label = "Build base database, extended (isotopes+adducts) or both?",
                                                                                                                                                    choices = c("base","extended","both"),selected = "extended"),
                                                                                                                                shiny::tags$i("For example: if you only defined a new adduct, pick 'extended' as the source database doesn't change.")
                                                   )
                                                   )),
                                                   shiny::uiOutput("db_build_ui") #%>% shinycssloaders::withSpinner() # see server, is autogenerated now
                                   ),
                                   shiny::tabPanel("data import", icon = shiny::icon("upload", class = "outlined"),
                                                   shiny::fluidRow(shiny::column(12, align="center",
                                                                                 shiny::textInput("proj_name_new", label = "STEP 1: What is your project name?", value = ""),
                                                                                 shiny::sliderInput("ppm", "STEP 2: What level accuracy does your mass spectrometer have?",min = 0.01,max = 50,value = 5,step = .01))),
                                                   shiny::hr(),
                                                   shiny::fluidRow(shiny::column(3, align="center",
                                                                                 shiny::imageOutput("merge_icon",inline = T),br(),
                                                                                 shiny::tags$b("STEP 3: Click buttons to load data."),
                                                                                 br(),br(),
                                                                                 div(shiny::textInput("wipe_regex",
                                                                                                  tags$i("Regex to adjust peaklist names to metadata sample names - the match is removed from each name (optional):"), 
                                                                                                  placeholder = "", 
                                                                                                  width="50%"), style='font-size:70%'),
                                                                                 br(),
                                                                                 shinyFiles::shinyFilesButton('metadata', 'metadata', 'Select metadata', FALSE),
                                                                                 condition = "input.importmode == 'csv'",
                                                                                                         shinyFiles::shinyFilesButton('outlist_pos', '+ peaks', 'Select + mode peaks', FALSE),
                                                                                                         shinyFiles::shinyFilesButton('outlist_neg', '- peaks', 'Select - mode peaks', FALSE)
                                                                                 
                                                   )
                                                   ,shiny::column(2, align="center", #ok
                                                                  shiny::tags$b("STEP 4: Merge data and metadata"),shiny::br(),shiny::br(),
                                                                  shinyWidgets::circleButton("create_db", icon = shiny::icon("long-arrow-alt-right", class = "fa-2x"), size = "lg"))
                                                   ,shiny::column(2, align="center", # issue lol
                                                                  shiny::imageOutput("db_icon")
                                                   )
                                                   ,shiny::column(2, align="center",
                                                                  shiny::tags$b("STEP 5: Convert to input-ready format"),
                                                                  shiny::br(),shiny::br(),
                                                                  shinyWidgets::circleButton("create_csv", icon = shiny::icon("long-arrow-alt-right", class = "fa-2x"), size = "lg"))
                                                   ,shiny::column(3, align="center",
                                                                  shiny::imageOutput("laptop_icon", inline=T),shiny::br(),shiny::br(),
                                                                  shiny::div(DT::dataTableOutput('csv_tab'),style='font-size:80%')
                                                   )
                                                   ),
                                                   shiny::fluidRow(shiny::column(3, align="center",
                                                                                 shiny::tags$i("Input files chosen?"),shiny::br(),shiny::br(),
                                                                                 shiny::imageOutput("proj_merge_check")
                                                   ),
                                                   shiny::column(2, align="center",
                                                                 shiny::tags$i("Database present?"),shiny::br(),shiny::br(),
                                                                 shiny::imageOutput("proj_db_check"),offset = 2),
                                                   shiny::column(3, align="center",
                                                                 shiny::tags$i("Final table present?"),shiny::br(),shiny::br(),
                                                                 shiny::imageOutput("proj_csv_check", inline=T),shiny::br(),shiny::br(),
                                                                 shiny::tags$b("STEP 6: If "), shiny::icon("check-circle"), shiny::tags$b(" continue to normalization"),
                                                                 offset = 2))
                                   ),
                                   # this tab is used to perform normalization of your data. settings are processed as input$filt_type etc. in 'server'.
                                   tabPanel("normalize",  icon = shiny::icon("shower",class = "outlined"), value="filter",
                                            shiny::fluidRow(align="center",shiny::column(3, 
                                                                          shiny::selectInput(width = "80%",'samp_var', 'Which variable represents sample amount/concentration?', choices = c("")), #TODO: only show this when normalize by sample specific factor (specnorm) is selected
                                                                          shiny::selectizeInput('batch_var', 'What are your batch variables?', choices = c("batch"), multiple=TRUE, options = list(maxItems = 2L)),
                                                                          shiny::actionButton("check_csv", "Get options", icon=shiny::icon("refresh")),
                                                                          shiny::hr(),
                                                                          shinyWidgets::sliderTextInput("perc_limit","Max. missing feature percent:",
                                                                                                        choices=c(0, 0.0001, 0.001, 0.01, 0.1, seq(1, 100, 1)),
                                                                                                        selected=1, grid = T),
                                                                          shiny::selectInput(width = "80%",'filt_type', 'How will you filter your m/z values?', choices = list("Interquantile range"="iqr",
                                                                                                                                                                 "Relative stdev"="rsd",
                                                                                                                                                                 "Non-parametric relative stdev"="nrsd",
                                                                                                                                                                 "Mean"="mean",
                                                                                                                                                                 "Standard deviation"="sd",
                                                                                                                                                                 "Median absolute deviation"="mad",
                                                                                                                                                                 "Median"="median",
                                                                                                                                                                 "None"="none"),
                                                                                             selected = "rsd"),
                                                                          shiny::selectInput(width = "80%",'norm_type', 'What type of normalization do you want to do?', choices = list("Quantile normalization"="QuantileNorm",
                                                                                                                                                                          "By reference feature"="ProbNorm",
                                                                                                                                                                          "By reference compound"="CompNorm",
                                                                                                                                                                          "By sample specific factor"="SpecNorm",
                                                                                                                                                                          "Sum"="SumNorm",
                                                                                                                                                                          "Median"="MedianNorm",
                                                                                                                                                                          "None"="NULL"), 
                                                                                             selected="SumNorm"),
                                                                          shiny::uiOutput("ref_select"),
                                                                          shiny::selectInput(width = "80%",'trans_type', 'How will you transform your data?', choices = list("Log transform"="LogNorm",
                                                                                                                                                               "Cubic root transform"="CrNorm",
                                                                                                                                                               "None"="NULL"), 
                                                                                             selected="LogNorm"),
                                                                          shiny::selectInput(width = "80%",'scale_type', 'How will you scale your data?', choices = list("Autoscale/Z-transform"="AutoNorm",
                                                                                                                                                           "Mean-center"="MeanCenter",
                                                                                                                                                           "Pareto Scaling"="ParetoNorm",
                                                                                                                                                           "Range scaling"="RangeNorm",
                                                                                                                                                           "None"="NULL"),
                                                                                             selected="AutoNorm"),
                                                                          shiny::selectInput(width = "80%",'miss_type', 'How to deal with missing values?', choices = list("Half feature minimum"="colmin",
                                                                                                                                                             "Half sample minimum"="rowmin",
                                                                                                                                                             "Total minimum"="min",
                                                                                                                                                             "Random forest"="rf",
                                                                                                                                                             #"Impute w/ regression"="regr",
                                                                                                                                                             "KNN imputation"="knn",
                                                                                                                                                             "SVD imputation"="svdImpute",
                                                                                                                                                             "BPCA imputation"="bpca",
                                                                                                                                                             "PPCA imputation"="ppca",
                                                                                                                                                             "Median"="median",
                                                                                                                                                             "Mean"="mean",
                                                                                                                                                             "Leave them out"="exclude",
                                                                                                                                                             "Leave them alone"="none"),
                                                                                             selected = "rf"),
                                                                          shiny::conditionalPanel("input.miss_type == 'rf'",
                                                                                                  shiny::sliderInput("rf_norm_ntree", label = "Trees built per variable", value = 10, min = 1, max = 50, step=1),
                                                                                                  #numericInput("rf_norm_mtry", label = "Trees built per variable", value = 10, min = 1, max = 50)
                                                                                                  shiny::radioButtons("rf_norm_parallel", label = "Parallelize?", choices = list("no",
                                                                                                                                                                                 "forests",
                                                                                                                                                                                 "variables"),
                                                                                                                      selected = "variables")
                                                                          ),
                                                                          # - - - - - -
                                                                          MetaboShiny::switchButton(inputId = "remove_outliers",
                                                                                                    label = "Exclude outliers?",
                                                                                                    value = FALSE, col = "BW", type = "YN"),
                                                                          shiny::actionButton("initialize", "Go", icon=shiny::icon("hand-o-right")),
                                                                          shiny::hr(),
                                                                          shiny::imageOutput("dataset_icon",inline = T),
                                                                          shiny::fileInput("pat_dataset", "Import dataset",
                                                                                           multiple = F,
                                                                                           accept = c(".RData")),
                                                                          shiny::actionButton("import_dataset", "Import", icon = shiny::icon("hand-peace-o")),
                                                                          shiny::imageOutput("dataset_upload_check",inline = T)
                                            ), shiny::column(9,
                                                             # show the summary plots post-normalization
                                                             navbarPage(inverse=F,shiny::h3("explore"),
                                                                        tabPanel("m/z values",# icon=shiny::icon("braille"),
                                                                                 shiny::fluidRow(shiny::column(6,shiny::plotOutput("var1",height='300px')),
                                                                                                 shiny::column(6,shiny::plotOutput("var3", height='300px'))
                                                                                 ),
                                                                                 shiny::fluidRow(shiny::column(6,shiny::plotOutput("var2", height='500px')),
                                                                                                 shiny::column(6,shiny::plotOutput("var4", height='500px')))
                                                                        ),
                                                                        shiny::tabPanel("samples",# icon=shiny::icon("tint"),
                                                                                        shiny::fluidRow(shiny::column(6,shiny::plotOutput("samp1",height='300px')),
                                                                                                        shiny::column(6,shiny::plotOutput("samp3", height='300px'))
                                                                                        ),
                                                                                        shiny::fluidRow(shiny::column(6,shiny::plotOutput("samp2", height='500px')),
                                                                                                        shiny::column(6,shiny::plotOutput("samp4", height='500px')))
                                                                        )
                                                             )
                                            )
                                            )),
                                   shiny::tabPanel("prematch", icon = shiny::icon("search", class = "outlined"), value = "prematch",
                                                   # - - - pre-matching part - - -
                                                   shiny::fluidRow(align="center",
                                                                   MetaboShiny::switchButton(inputId = "do_prematch",
                                                                                             label = "Do matching beforehand?",
                                                                                             col = "BW",
                                                                                             type = "YN"),
                                                                   shiny::tags$i("All m/z values will be searched in the databases of choice and the results will be saved to your save file for fast access."),shiny::br(),
                                                                   shiny::tags$i("Search results can still be overridden by manual searching. Don't forget to save after!")),
                                                   shiny::br(),
                                                   shiny::fluidRow(align="center",
                                                                   shiny::column(2),
                                                                   shiny::column(8, shiny::conditionalPanel("input.do_prematch == true",
                                                                                                            shiny::h2("Included databases:"),
                                                                                                            shiny::uiOutput("db_prematch_select"),
                                                                                                            shinyWidgets::circleButton("select_db_prematch_all",
                                                                                                                                       icon = shiny::icon("shopping-cart"),
                                                                                                                                       size = "default")),
                                                                                 shiny::hr(),
                                                                                 shiny::fluidRow(shiny::column(6,shiny::h2("Find matches"),
                                                                                                               shinyWidgets::circleButton(inputId = "prematch",
                                                                                                                                          icon = shiny::icon("searchengin"))),
                                                                                                 shiny::column(6,shiny::h2("Clear matches"),
                                                                                                               shinyWidgets::circleButton(inputId = "clear_prematch",
                                                                                                                                          icon = shiny::icon("trash"))))
                                                                   ),
                                                                   shiny::column(2)
                                                   )),
                                   # this tab is the main analysis tab. all tabs for all analyses are listed here, but the visibility is changed depending on the current experiment
                                   shiny::tabPanel("analyse",  icon = shiny::icon("bar-chart",class = "outlined"), value = "analysis",
                                                   sidebarLayout(position="right",
                                                                 mainPanel = mainPanel(width = 8,
                                                                                       shiny::tabsetPanel(id="statistics", selected = "pca",
                                                                                                          #shiny::navbarPage(inverse=F, "", id="statistics", selected = "pca", collapsible = T,
                                                                                                          # TODO: T-SNE
                                                                                                          # this tab shows general information, mostly a message with 'please give me some data' :-)
                                                                                                          shiny::tabPanel(shiny::icon("star"), value = "inf",
                                                                                                                          shiny::fluidRow(shiny::column(width=12, align="center",
                                                                                                                                                        shiny::br(),shiny::br(),shiny::br(),shiny::br(),
                                                                                                                                                        #shiny::hr(),
                                                                                                                                                        #shiny::icon("arrow-right","fa-lg"), shiny::icon("arrow-right","fa-lg"), shiny::icon("arrow-right","fa-lg"),
                                                                                                                                                        shiny::br(),shiny::br(),
                                                                                                                                                        shiny::h2("Please select a variable of interest in the sidebar!"),shiny::br(),
                                                                                                                                                        shiny::icon("exchange", "fa-4x"),
                                                                                                                                                        shiny::br(),shiny::br(),shiny::br()
                                                                                                                                                        #shiny::hr()
                                                                                                                                                        #shiny::icon("arrow-right","fa-lg"), shiny::icon("arrow-right","fa-lg"), shiny::icon("arrow-right","fa-lg")
                                                                                                                          ))),
                                                                                                          shiny::tabPanel("dimension reduction", value = "dimred",  icon=shiny::icon("cube"),
                                                                                                                          shiny::navbarPage(inverse=T, shiny::icon("cube"), id = "dimred",
                                                                                                                                            # loading this tab performs PCA. summary and loading tables, alongside a 2d/3d PCA plot, are available here.
                                                                                                                                            shiny::tabPanel("pca", value = "pca", #icon=shiny::icon("cube"),
                                                                                                                                                            shiny::fluidRow(align="center",shiny::column(12,plotly::plotlyOutput("plot_pca",height = "600px", width="600px"))),#%>% shinycssloaders::withSpinner())),
                                                                                                                                                            shiny::fluidRow(align="center",shiny::column(12,
                                                                                                                                                                                                         MetaboShiny::switchButton("pca_2d3d", label = "", col = "BW", type = "2d3d", value=T))),
                                                                                                                                                            shiny::hr(),
                                                                                                                                                            shiny::fluidRow(shiny::column(3,
                                                                                                                                                                                          shiny::selectInput("pca_x", label = "X axis:", choices = paste0("PC",1:20),selected = "PC1",width="80%"),
                                                                                                                                                                                          shiny::selectInput("pca_y", label = "Y axis:", choices = paste0("PC",1:20),selected = "PC2",width="80%"),
                                                                                                                                                                                          shiny::selectInput("pca_z", label = "Z axis:", choices = paste0("PC",1:20),selected = "PC3",width="80%")),
                                                                                                                                                                            shiny::column(9,
                                                                                                                                                                                          shiny::tabsetPanel(id="pca_2",
                                                                                                                                                                                                             shiny::tabPanel(title="Table",
                                                                                                                                                                                                                             shiny::div(DT::dataTableOutput('pca_tab',width="100%"),style='font-size:80%')),
                                                                                                                                                                                                             shiny::tabPanel(title="Scree",
                                                                                                                                                                                                                             shiny::plotOutput("pca_scree", width = "100%", height="250px")
                                                                                                                                                                                                             ),
                                                                                                                                                                                                             shiny::tabPanel(title="Loadings",
                                                                                                                                                                                                                             shiny::div(DT::dataTableOutput('pca_load_tab',width="100%"),style='font-size:80%'))
                                                                                                                                                                                          ))
                                                                                                                                                            )
                                                                                                                                            ),
                                                                                                                                            # TODO: enable the sparse and orthogonal PLS-DA options in metaboanalystR
                                                                                                                                            # this tab is used to perform pls-da. it triggers on 'go' button as it is a time costly analysis.
                                                                                                                                            shiny::tabPanel("pls-da", value = "plsda",
                                                                                                                                                            shiny::fluidRow(align="center",shiny::column(12,plotly::plotlyOutput("plot_plsda",height = "500px", width="500px"))),
                                                                                                                                                            shiny::fluidRow(align="center",shiny::column(12,
                                                                                                                                                                                                         MetaboShiny::switchButton("plsda_2d3d", label = "", col = "BW", type = "2d3d"))),
                                                                                                                                                            shiny::hr(),
                                                                                                                                                            shiny::fluidRow(shiny::column(3,
                                                                                                                                                                                          shiny::div(style="display:inline-block",
                                                                                                                                                                                                     shiny::selectInput("plsda_type",
                                                                                                                                                                                                                        label="Type:",
                                                                                                                                                                                                                        choices=list("Normal"="normal")
                                                                                                                                                                                                                        #,
                                                                                                                                                                                                                        #             "Orthogonal"="ortho",
                                                                                                                                                                                                                        #             "Sparse"="sparse")
                                                                                                                                                                                                                        ,width = '100px',
                                                                                                                                                                                                                        selected=1)),
                                                                                                                                                                                          shiny::div(style="display:inline-block",
                                                                                                                                                                                                     shinyWidgets::circleButton("do_plsda", icon = shiny::icon("hand-pointer-o"), size = "sm")
                                                                                                                                                                                          ),
                                                                                                                                                                                          shiny::selectInput("plsda_x", label = "X axis:", choices = paste0("PC",1:8),selected = "PC1",width="80%"),
                                                                                                                                                                                          shiny::selectInput("plsda_y", label = "Y axis:", choices = paste0("PC",1:8),selected = "PC2",width="80%"),
                                                                                                                                                                                          shiny::selectInput("plsda_z", label = "Z axis:", choices = paste0("PC",1:8),selected = "PC3",width="80%")),
                                                                                                                                                                            shiny::column(9,
                                                                                                                                                                                          shiny::tabsetPanel(id="plsda_2",
                                                                                                                                                                                                             shiny::tabPanel(title="Cross-validation",
                                                                                                                                                                                                                             shiny::plotOutput("plsda_cv_plot")),
                                                                                                                                                                                                             shiny::tabPanel(title="Permutation",
                                                                                                                                                                                                                             shiny::plotOutput("plsda_perm_plot")),
                                                                                                                                                                                                             shiny::tabPanel(title="Table",
                                                                                                                                                                                                                             shiny::div(DT::dataTableOutput('plsda_tab',width="100%"),style='font-size:80%')),
                                                                                                                                                                                                             shiny::tabPanel(title="Loadings",
                                                                                                                                                                                                                             shiny::div(DT::dataTableOutput('plsda_load_tab',width="100%"),style='font-size:80%'))
                                                                                                                                                                                          ))
                                                                                                                                                            )
                                                                                                                                            ),
                                                                                                                                            shiny::tabPanel("t-sne", value = "tsne",
                                                                                                                                                            shiny::helpText("working on it")
                                                                                                                                            )
                                                                                                                          )),
                                                                                                          shiny::tabPanel("per m/z", value = "permz", icon=shiny::icon("fingerprint"),
                                                                                                                          shiny::navbarPage(inverse=T, shiny::icon("fingerprint"), id = "permz",
                                                                                                                                            shiny::tabPanel("t-test", value="tt",
                                                                                                                                                            shiny::fluidRow(plotly::plotlyOutput('tt_specific_plot',width="100%")),
                                                                                                                                                            shiny::fluidRow(align="center",
                                                                                                                                                                            MetaboShiny::sardine(MetaboShiny::switchButton("tt_nonpar", "Non-parametric?", col="BW", type="YN", value = T)),
                                                                                                                                                                            #MetaboShiny::sardine(shiny::uiOutput("tt_parbutton")),
                                                                                                                                                                            MetaboShiny::sardine(MetaboShiny::switchButton("tt_eqvar", "Equal variance?", col="BW", type="YN", value = T))
                                                                                                                                                            ),
                                                                                                                                                            shiny::navbarPage(inverse=F,"",
                                                                                                                                                                              shiny::tabPanel("", icon=shiny::icon("table"),
                                                                                                                                                                                              shiny::div(DT::dataTableOutput('tt_tab',width="100%"),style='font-size:80%'))
                                                                                                                                                                              ,shiny::tabPanel("", icon=shiny::icon("area-chart"),
                                                                                                                                                                                               shinycssloaders::withSpinner(plotly::plotlyOutput('tt_overview_plot',height="300px"))
                                                                                                                                                                              )
                                                                                                                                                            )),
                                                                                                                                            shiny::tabPanel("anova", value="aov",
                                                                                                                                                            shiny::fluidRow(plotly::plotlyOutput('aov_specific_plot',width="100%")),
                                                                                                                                                            shiny::navbarPage(inverse=F,"",
                                                                                                                                                                              shiny::tabPanel("", icon=shiny::icon("table"),
                                                                                                                                                                                              shiny::div(DT::dataTableOutput('aov_tab',width="100%"),style='font-size:80%'))
                                                                                                                                                                              ,shiny::tabPanel("", icon=shiny::icon("area-chart"),
                                                                                                                                                                                               shinycssloaders::withSpinner(plotly::plotlyOutput('aov_overview_plot',height="300px"))
                                                                                                                                                                              )
                                                                                                                                                            )),
                                                                                                                                            shiny::tabPanel("fold-change", value="fc",
                                                                                                                                                            shiny::fluidRow(plotly::plotlyOutput('fc_specific_plot',width="100%")),
                                                                                                                                                            shiny::navbarPage(inverse=F,"",
                                                                                                                                                                              shiny::tabPanel("", icon=shiny::icon("table"),
                                                                                                                                                                                              shiny::div(DT::dataTableOutput('fc_tab',width="100%"),style='font-size:80%'))
                                                                                                                                                                              ,shiny::tabPanel("", icon=shiny::icon("area-chart"),
                                                                                                                                                                                               shinycssloaders::withSpinner(plotly::plotlyOutput('fc_overview_plot',height="300px"))
                                                                                                                                                                              ))
                                                                                                                                            ),
                                                                                                                                            shiny::tabPanel("meba", value="meba",
                                                                                                                                                            shiny::fluidRow(plotly::plotlyOutput('meba_specific_plot',height="600px")),
                                                                                                                                                            shiny::fluidRow(shiny::div(DT::dataTableOutput('meba_tab', width="100%"),style='font-size:80%'))
                                                                                                                                            ),
                                                                                                                                            shiny::tabPanel("asca", value="asca",
                                                                                                                                                            shiny::fluidRow(plotly::plotlyOutput('asca_specific_plot', height="600px")),
                                                                                                                                                            shiny::fluidRow(shiny::div(DT::dataTableOutput('asca_tab',width="100%"),style='font-size:80%'))
                                                                                                                                            )
                                                                                                                          )
                                                                                                          ),
                                                                                                          shiny::tabPanel("overview analyses", value = "overview", icon=shiny::icon("globe"),
                                                                                                                          shiny::navbarPage(inverse=T, shiny::icon("globe"), id = "overview",
                                                                                                                                            shiny::tabPanel("volcano plot", value="volc",
                                                                                                                                                            shiny::fluidRow(shinycssloaders::withSpinner(plotly::plotlyOutput('volc_plot',width="100%",height="600px"))),
                                                                                                                                                            shiny::fluidRow(shiny::div(DT::dataTableOutput('volc_tab',width="100%"),style='font-size:80%'))
                                                                                                                                            ),
                                                                                                                                            shiny::tabPanel("heatmap", value="heatmap",
                                                                                                                                                            shinycssloaders::withSpinner(plotly::plotlyOutput("heatmap",width="100%",height="700px")),
                                                                                                                                                            shiny::br(),
                                                                                                                                                            shiny::fluidRow(shiny::column(align="center",
                                                                                                                                                                                          width=12,
                                                                                                                                                                                          shiny::sliderInput("heatmap_topn", "Use top ... from table:", value=100, min = 10, max = 200))
                                                                                                                                                            ),
                                                                                                                                                            shiny::fluidRow(shiny::column(align="center",
                                                                                                                                                                                          width=12,
                                                                                                                                                                                          #shiny::uiOutput("heatbutton"),
                                                                                                                                                                                          shiny::selectInput(width = "80%","heattable", label = "Use statistics from:", choices = c(), selected = c()),
                                                                                                                                                                                          MetaboShiny::switchButton("heatsign", label = "Only significant hits?", col = "GB", type = "YN"),
                                                                                                                                                                                          MetaboShiny::switchButton("heatlimits", label = "Color based on -all- metabolites?", col = "GB", type = "YN")
                                                                                                                                                            ))
                                                                                                                                            ),
                                                                                                                                            # this tab is used to find overlapping features of interest between analyses
                                                                                                                                            # TODO: enable this with multiple saved mSets in mSet$storage
                                                                                                                                            shiny::tabPanel(title="venn", value="venn", #icon=shiny::icon("comments"),
                                                                                                                                                            sidebarLayout(position = "left",
                                                                                                                                                                          sidebarPanel = sidebarPanel(
                                                                                                                                                                            shiny::fluidRow(shiny::div(DT::dataTableOutput('venn_unselected'),style='font-size:80%'), align="center"),
                                                                                                                                                                            shiny::fluidRow(shinyWidgets::circleButton("venn_add", icon=shiny::icon("arrow-down"), size="sm"),
                                                                                                                                                                                            shinyWidgets::circleButton("venn_remove", icon=shiny::icon("arrow-up"), size="sm"),
                                                                                                                                                                                            align="center"),
                                                                                                                                                                            shiny::fluidRow(shiny::div(DT::dataTableOutput('venn_selected'),style='font-size:80%'),align="center"),
                                                                                                                                                                            shiny::hr(),
                                                                                                                                                                            shiny::fluidRow(
                                                                                                                                                                              shiny::sliderInput("venn_tophits", label = "Only include top:", min = 1, max = 200, post = " hits", value=20)
                                                                                                                                                                              ,align="center"),
                                                                                                                                                                            shiny::fluidRow(
                                                                                                                                                                              shinyWidgets::circleButton("venn_build", icon=shiny::icon("hand-pointer-o"),size="default")
                                                                                                                                                                              ,align="center")
                                                                                                                                                                          ),
                                                                                                                                                                          mainPanel = mainPanel(
                                                                                                                                                                            shiny::hr(),
                                                                                                                                                                            shiny::plotOutput("venn_plot",inline = F),
                                                                                                                                                                            # find the overlapping compounds between the groups you want to compare (user select)
                                                                                                                                                                            # TODO: enable this with clicking the numbers/areas
                                                                                                                                                                            shiny::fluidRow(shiny::selectInput(width = "80%","intersect_venn", label = "Show hits from (only):", selected = 1,choices = "",multiple = T),
                                                                                                                                                                                            align="center"),
                                                                                                                                                                            shiny::fluidRow(shiny::uiOutput("venn_pval"), align="center"),
                                                                                                                                                                            shiny::br(),
                                                                                                                                                                            shiny::fluidRow(shiny::div(DT::dataTableOutput('venn_tab'),style='font-size:80%'),
                                                                                                                                                                                            align="center")
                                                                                                                                                                          ))
                                                                                                                                            ),
                                                                                                                                            shiny::tabPanel("power calculation", value="power",
                                                                                                                                                            shiny::fluidRow(align="center",plotly::plotlyOutput('power_plot',width="100%",height="600px")),
                                                                                                                                                            shiny::fluidRow(align="center",shiny::sliderInput("power_nsamp",
                                                                                                                                                                                                              label = "Up to how many samples (per group)?",
                                                                                                                                                                                                              value = 500,
                                                                                                                                                                                                              min = 5, 
                                                                                                                                                                                                              max = 999,
                                                                                                                                                                                                              step = 1),
                                                                                                                                                                            shiny::selectInput("power_comps", "Which comparisons do you want to make?",
                                                                                                                                                                                               choices = c(),
                                                                                                                                                                                               multiple = T),
                                                                                                                                                                            shiny::numericInput("power_fdr", "False discovery rate:", 
                                                                                                                                                                                                value = 0.1, 
                                                                                                                                                                                                max = 1,
                                                                                                                                                                                                min = 0.00001)),
                                                                                                                                                            shiny::fluidRow(align="center",shinyWidgets::circleButton("do_power", size="lg", icon=shiny::icon("arrow-up")))
                                                                                                                                            )
                                                                                                                          )
                                                                                                          ),
                                                                                                          # this tab enables machine learning
                                                                                                          shiny::tabPanel("machine learning", value = "ml", icon=shiny::icon("signature"),
                                                                                                                          shiny::br(),
                                                                                                                          shiny::navbarPage(inverse=F, shiny::icon("signature"), id = "ml2",
                                                                                                                                            shiny::tabPanel("initialize", value="init",
                                                                                                                                                            shiny::fluidRow(
                                                                                                                                                              shiny::column(width=3,align="center",
                                                                                                                                                                            shiny::selectInput("ml_perf_metr", label=shiny::h2("Performance metric"),
                                                                                                                                                                                               choices = c("boot", "boot632", "optimism_boot",
                                                                                                                                                                                                           "boot_all", "cv", "repeatedcv",
                                                                                                                                                                                                           "LOOCV", "LGOCV", "none", "oob",
                                                                                                                                                                                                           "timeslice", "addaptive_cv", "adaptive_boot",
                                                                                                                                                                                                           "adaptive_LGOCV"),
                                                                                                                                                                                               multiple = F, selected = "repeatedcv"),
                                                                                                                                                                            shiny::sliderInput("ml_train_perc",
                                                                                                                                                                                               label = shiny::h2("Percentage in training"),
                                                                                                                                                                                               min = 1,
                                                                                                                                                                                               max = 100,
                                                                                                                                                                                               step = 1,
                                                                                                                                                                                               value = 60,
                                                                                                                                                                                               post = "%"),
                                                                                                                                                                            shiny::selectInput("ml_folds", label=shiny::h2("Fold CV"),choices = c("5",
                                                                                                                                                                                                                                                  "10",
                                                                                                                                                                                                                                                  "20",
                                                                                                                                                                                                                                                  "50",
                                                                                                                                                                                                                                                  "LOOCV"),
                                                                                                                                                                                               multiple = F),
                                                                                                                                                                            shiny::sliderInput("ml_attempts",
                                                                                                                                                                                               label = "Attempts",
                                                                                                                                                                                               min = 1,
                                                                                                                                                                                               max = 100,
                                                                                                                                                                                               step = 1,
                                                                                                                                                                                               value = 20,
                                                                                                                                                                                               post = "x")
                                                                                                                                                              ),
                                                                                                                                                              shiny::column(width=6,align="center",
                                                                                                                                                                            shiny::selectInput("ml_method",
                                                                                                                                                                                               label = shiny::h2("Used algorithm"),
                                                                                                                                                                                               selected = "glmnet",
                                                                                                                                                                                               choices = as.list(gbl$constants$ml.models),
                                                                                                                                                                                               multiple = F),
                                                                                                                                                                            shiny::div(shiny::uiOutput("ml_params"), style = "font-size:60%"),
                                                                                                                                                                            shiny::selectizeInput("ml_preproc", label = shiny::h2("Data reprocessing"),
                                                                                                                                                                                                  choices = c("center", "scale"),
                                                                                                                                                                                                  selected = c("center", "scale"), multiple=T),
                                                                                                                                                                            MetaboShiny::switchButton("downsample", label = "Downsample?",col = "BW", value = F, type = "YN"),
                                                                                                                                                                            shinyWidgets::circleButton("do_ml",
                                                                                                                                                                                                       icon = shiny::h3(paste("Go"),
                                                                                                                                                                                                                        shiny::icon("hand-pointer-o", "fa-lg")),
                                                                                                                                                                                                       status = "default",
                                                                                                                                                                                                       size = "lg")
                                                                                                                                                              ),
                                                                                                                                                              shiny::column(width=3,align="center",
                                                                                                                                                                            shiny::selectizeInput("ml_include_covars", label = "Use which non-m/z info for prediction?", choices=c(), multiple=TRUE),
                                                                                                                                                                            shiny::fluidRow(shiny::textOutput("ml_train_ss"),
                                                                                                                                                                                            shiny::actionButton("ml_train_ss", label = "train on:", icon = shiny::icon("arrow-up"))),
                                                                                                                                                                            shiny::fluidRow(shiny::textOutput("ml_test_ss"),
                                                                                                                                                                                            shiny::actionButton("ml_test_ss", label = "test on:", icon = shiny::icon("arrow-up"))),
                                                                                                                                                                            shiny::br(),
                                                                                                                                                                            shiny::textInput("ml_name", label=shiny::h3("Name:"), value = "all"))
                                                                                                                                                            )
                                                                                                                                            ),
                                                                                                                                            shiny::tabPanel("results", value="res", icon=shiny::icon("poll"),
                                                                                                                                                            shiny::br(),
                                                                                                                                                            shiny::div(shiny::selectInput("show_which_ml", 
                                                                                                                                                                                          label = "Plot which model?", 
                                                                                                                                                                                          choices = c())),
                                                                                                                                                            shiny::navbarPage(title=shiny::icon("poll"),id="ml_results",inverse=F,
                                                                                                                                                                              shiny::tabPanel(title = "roc",value = "roc",icon=shiny::icon("area-chart"),
                                                                                                                                                                                              plotly::plotlyOutput("ml_roc",height = "600px"),
                                                                                                                                                                                              shiny::div(DT::dataTableOutput("ml_tab",width="100%"),style='font-size:80%')),
                                                                                                                                                                              shiny::tabPanel("importance",value= "bar",icon=shiny::icon("star"),
                                                                                                                                                                                              shiny::fluidRow(plotly::plotlyOutput("ml_bar", width = "100%", height="600px")),
                                                                                                                                                                                              shiny::fluidRow(
                                                                                                                                                                                                shiny::column(12, shiny::sliderInput("ml_top_x",
                                                                                                                                                                                                                                     label = "Show top:",
                                                                                                                                                                                                                                     min = 10,
                                                                                                                                                                                                                                     max = 200,
                                                                                                                                                                                                                                     step=10,
                                                                                                                                                                                                                                     value=20), align="center")
                                                                                                                                                                                              )
                                                                                                                                                                              )
                                                                                                                                                            )
                                                                                                                                            )
                                                                                                                          )
                                                                                                          )
                                                                                       )
                                                                 ),
                                                                 # this is the sidebar that shows in the analysis tab. contains a lot of settings on the current variable of interest, plot themes and colours, and venn diagrams.
                                                                 sidebarPanel =
                                                                   sidebarPanel(align="center",width = 4,
                                                                                shiny::tabsetPanel(id = "anal_sidebar", selected="switch/subset",#type = "pills",
                                                                                                   shiny::tabPanel(title="export",icon=shiny::icon("file"),
                                                                                                                   shiny::radioButtons("export_format", "Which format do you want to export plots to?",
                                                                                                                                       choices = list(".svg", ".eps", ".png", ".jpeg", ".pdf")),
                                                                                                                   shinyWidgets::circleButton("export_plot", icon=shiny::icon("hand-o-up"))),
                                                                                                   shiny::tabPanel(title="search", icon=shiny::icon("search"),
                                                                                                                   shiny::br(),
                                                                                                                   shinyBS::bsCollapse(shinyBS::bsCollapsePanel(title=shiny::h2("Settings"), style="info",
                                                                                                                                                                shiny::tabsetPanel(id="tab_iden_1", selected = "start",
                                                                                                                                                                                   # forward searching
                                                                                                                                                                                   shiny::tabPanel(title=shiny::icon("database"),
                                                                                                                                                                                                   value="start",
                                                                                                                                                                                                   shiny::uiOutput("db_search_select"),
                                                                                                                                                                                                   br(),
                                                                                                                                                                                                   shiny::div(id = "curly-brace", shiny::div(id = "left", class = "brace"),
                                                                                                                                                                                                              shiny::div(id = "right", class = "brace")),
                                                                                                                                                                                                   br(),br(),
                                                                                                                                                                                                   shinyWidgets::circleButton("select_db_all",
                                                                                                                                                                                                                              icon = shiny::icon("shopping-cart"),
                                                                                                                                                                                                                              size = "default") # shiny::icon("fingerprint"), size = "sm")
                                                                                                                                                                                   ), # clicky buttons for database selection; this is generated in 'server'
                                                                                                                                                                                   shiny::tabPanel(title=shiny::icon("chart-bar"),
                                                                                                                                                                                                   shinycssloaders::withSpinner(plotly::plotlyOutput("curr_plot", height="300px", width="100%"))
                                                                                                                                                                                   ),
                                                                                                                                                                                   shiny::tabPanel(title=shiny::icon("magic"),
                                                                                                                                                                                                   shiny::fluidRow(align="center",
                                                                                                                                                                                                                   br(),
                                                                                                                                                                                                                   shiny::h2("Formula prediction + ChemSpider + PubChem settings"),
                                                                                                                                                                                                                   br(),
                                                                                                                                                                                                                   shiny::passwordInput("apikey", 
                                                                                                                                                                                                                                        label = "If you want to use ChemSpider, please register on their website and enter your API key below.",
                                                                                                                                                                                                                                        value = ""),
                                                                                                                                                                                                                   sardine(shinyWidgets::circleButton("set_api", icon = icon("save"))),sardine(shiny::textOutput("api_set")),
                                                                                                                                                                                                                   MetaboShiny::switchButton(inputId = "predict_details",
                                                                                                                                                                                                                                             label = "Get detailed PubChem matches? (SLOW, be warned!)",
                                                                                                                                                                                                                                             col = "BW", type = "YN", value = F),
                                                                                                                                                                                                                   MetaboShiny::switchButton(inputId = "predict_structure_check",
                                                                                                                                                                                                                                             label = "Uniformize ChemSpider/PubChem found structures?",
                                                                                                                                                                                                                                             col = "BW", type = "YN", value = T),
                                                                                                                                                                                                                   MetaboShiny::switchButton(inputId = "predict_adduct_rules",
                                                                                                                                                                                                                                             label = "Filter ChemSpider/PubChem hits with available structures using your adduct rules?",
                                                                                                                                                                                                                                             col = "BW", type = "YN", value = F))),
                                                                                                                                                                                   shiny::tabPanel(title=shiny::icon("star-half-alt"),
                                                                                                                                                                                                   shiny::selectInput(width = "80%","iso_score_method",
                                                                                                                                                                                                                      "Which method used to score compounds of same weight?",
                                                                                                                                                                                                                      selected="mscore",
                                                                                                                                                                                                                      choices=list("M-score"="mscore"
                                                                                                                                                                                                                                   #"Chi-square"="chisq",
                                                                                                                                                                                                                                   #"Mean absolute percentage error"="mape",
                                                                                                                                                                                                                                   #"SIRIUS"="sirius",
                                                                                                                                                                                                                                   #"Network-based"="network"
                                                                                                                                                                                                                      )),
                                                                                                                                                                                                   shiny::sliderInput("int_prec", label = "Intensity imprecision", min = 1, max = 100, value = 2, post = "%"),
                                                                                                                                                                                                   shinyWidgets::circleButton("score_iso", icon = shiny::icon("award"), size = "sm") # shiny::icon("fingerprint"), size = "sm")
                                                                                                                                                                                   )
                                                                                                                                                                ))),
                                                                                                                   br(),
                                                                                                                   shiny::fluidRow(align="center",
                                                                                                                                   shiny::uiOutput("manual_search"),
                                                                                                                                   shiny::div(
                                                                                                                                     MetaboShiny::sardine(shiny::div(shiny::icon("paw","fa-xs fa-rotate-90"),
                                                                                                                                                                     style="position:relative;
                                                                                                                     top:10px;")),
                                                                                                                                     MetaboShiny::sardine(shiny::div(shiny::icon("paw","fa-xs fa-rotate-90"),
                                                                                                                                                                     style="position:relative;
                                                                                                                     top:25px;")),
                                                                                                                                     MetaboShiny::sardine(shiny::div(shiny::icon("paw","fa-xs fa-rotate-90"),
                                                                                                                                                                     style="position:relative;
                                                                                                                     top:10px;")),
                                                                                                                                     MetaboShiny::sardine(shiny::h2(shiny::textOutput("curr_mz"),style="padding:10px;")),
                                                                                                                                     MetaboShiny::sardine(shiny::div(shiny::icon("paw","fa-xs fa-rotate-90"),
                                                                                                                                                                     style="position:relative;
                                                                                                                     top:10px;")),
                                                                                                                                     MetaboShiny::sardine(shiny::div(shiny::icon("paw","fa-xs fa-rotate-90"),
                                                                                                                                                                     style="position:relative;
                                                                                                                     top:25px;")),
                                                                                                                                     MetaboShiny::sardine(shiny::div(shiny::icon("paw","fa-xs fa-rotate-90"),
                                                                                                                                                                     style="position:relative;
                                                                                                                     top:10px;")),
                                                                                                                                     style="background-color:white;
                                                                                                         height:55px;
                                                                                                         width:100%;
                                                                                                         margin: 0 auto;
                                                                                                         border-top: 1px solid #DFDCDC;
                                                                                                         border-bottom: 1px solid #DFDCDC;")
                                                                                                                   ),
                                                                                                                   shiny::tabsetPanel(id="tab_iden_2",
                                                                                                                                      # forward searching
                                                                                                                                      shiny::tabPanel(title="mz > molecule",
                                                                                                                                                      shiny::hr(),
                                                                                                                                                      shinyBS::bsCollapse(shinyBS::bsCollapsePanel(title=shiny::h2("Compound info"), style="warning",
                                                                                                                                                                                                   shiny::tabsetPanel(id="tab_iden_3",
                                                                                                                                                                                                                      shiny::tabPanel(title=shiny::icon("atlas"),
                                                                                                                                                                                                                                      wellPanel(id = "def",style = "overflow-y:scroll; max-height: 200px",
                                                                                                                                                                                                                                                shiny::fluidRow(align="center",shiny::uiOutput("desc_ui"))
                                                                                                                                                                                                                                      )
                                                                                                                                                                                                                      ),
                                                                                                                                                                                                                      shiny::tabPanel(title=shiny::icon("atom"),
                                                                                                                                                                                                                                      shiny::fluidRow(align="center",shiny::uiOutput("curr_formula")),
                                                                                                                                                                                                                                      shiny::fluidRow(align="center",
                                                                                                                                                                                                                                                      shiny::plotOutput("curr_struct",inline=T))
                                                                                                                                                                                                                      )
                                                                                                                                                                                                   ))),
                                                                                                                                                      shinyBS::bsCollapse(shinyBS::bsCollapsePanel(title=shiny::h2("Search results"), style="error",
                                                                                                                                                                                                   shiny::tabsetPanel(id="tab_iden_4",selected = "start",
                                                                                                                                                                                                                      # forward searching
                                                                                                                                                                                                                      shiny::tabPanel(title=shiny::icon("table"), value="start",
                                                                                                                                                                                                                                      shiny::fluidRow(align="center",
                                                                                                                                                                                                                                                      shiny::imageOutput("empty",width="100%",height="1px"),# for finding the width of the molecule rendering;
                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                      sardine(shiny::icon("plus-circle", class = "fa-xs")), sardine(shiny::div(textOutput("curr_add"),style='font-size=50%')), 
                                                                                                                                                                                                                                                      sardine(shiny::icon("percentage", class = "fa-xs")), sardine(shiny::div(textOutput("curr_iso"),style='font-size=50%')),
                                                                                                                                                                                                                                                      sardine(shiny::icon("database", class = "fa-xs")), sardine(shiny::div(textOutput("curr_db"),style='font-size=50%')),
                                                                                                                                                                                                                                                      shiny::div(DT::dataTableOutput('match_tab'),style='font-size:80%'),
                                                                                                                                                                                                                                                      shiny::hr(),
                                                                                                                                                                                                                                                      MetaboShiny::switchButton(inputId = "auto_copy",
                                                                                                                                                                                                                                                                                label = "Auto-copy name to clipboard??",
                                                                                                                                                                                                                                                                                value = TRUE, col = "GB", type = "YN"),
                                                                                                                                                                                                                                                      shiny::helpText("Undo filtering"),
                                                                                                                                                                                                                                                      shinyWidgets::circleButton("undo_match_filt", icon = shiny::icon("undo-alt"), size = "sm") # shiny::icon("fingerprint"), size = "sm")
                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                      )),
                                                                                                                                                                                                                      shiny::tabPanel(title=shiny::icon("database"), value="pie_db",
                                                                                                                                                                                                                                      shiny::fluidRow(align = "center",
                                                                                                                                                                                                                                                      shinycssloaders::withSpinner(plotly::plotlyOutput("match_pie_db"))
                                                                                                                                                                                                                                      )
                                                                                                                                                                                                                      ),
                                                                                                                                                                                                                      shiny::tabPanel(title=shiny::icon("plus"), value = "pie_add",
                                                                                                                                                                                                                                      shiny::fluidRow(align = "center",
                                                                                                                                                                                                                                                      shinycssloaders::withSpinner(plotly::plotlyOutput("match_pie_add"))
                                                                                                                                                                                                                                      )
                                                                                                                                                                                                                      ),
                                                                                                                                                                                                                      shiny::tabPanel(title=shiny::icon("percentage"), value = "pie_iso",
                                                                                                                                                                                                                                      shiny::fluidRow(align = "center",
                                                                                                                                                                                                                                                      shinycssloaders::withSpinner( plotly::plotlyOutput("match_pie_iso"))
                                                                                                                                                                                                                                      )
                                                                                                                                                                                                                      ),
                                                                                                                                                                                                                      shiny::tabPanel(title=shiny::icon("cloud"), value = "word_cloud",
                                                                                                                                                                                                                                      shiny::fluidRow(align = "center",
                                                                                                                                                                                                                                                      shiny::conditionalPanel("input.wc_cloudbar == true",
                                                                                                                                                                                                                                                                              tagList(
                                                                                                                                                                                                                                                                                wordcloud2::wordcloud2Output("wordcloud_desc"),
                                                                                                                                                                                                                                                                                shiny::tags$script(HTML(
                                                                                                                                                                                                                                                                                  "$(document).on('click', '#canvas', function() {",
                                                                                                                                                                                                                                                                                  'word = document.getElementById("wcSpan").innerHTML;',
                                                                                                                                                                                                                                                                                  "Shiny.onInputChange('selected_word_desc', word);",
                                                                                                                                                                                                                                                                                  "});"
                                                                                                                                                                                                                                                                                ))
                                                                                                                                                                                                                                                                              )),
                                                                                                                                                                                                                                                      shiny::conditionalPanel("input.wc_cloudbar == false",
                                                                                                                                                                                                                                                                              plotly::plotlyOutput("wordbar_desc")
                                                                                                                                                                                                                                                      ),
                                                                                                                                                                                                                                                      shiny::sliderInput("wc_topn", "Top words shown:", min = 1, max = 100,step = 1,value = 30, width="60%"),
                                                                                                                                                                                                                                                      MetaboShiny::switchButton("wc_cloudbar", label = "", col = "BW", type = "CLBR",value = T))
                                                                                                                                                                                                                      ),
                                                                                                                                                                                                                      shiny::tabPanel(title=shiny::icon("searchengin"),
                                                                                                                                                                                                                                      shiny::fluidRow(align = "center",
                                                                                                                                                                                                                                      shiny::textInput('pm_query', "Search for:"),
                                                                                                                                                                                                                                      shiny::sliderInput('pm_year', "Paper publication range:",
                                                                                                                                                                                                                                                         min = 1900, max = as.numeric(format(Sys.Date(), '%Y')),
                                                                                                                                                                                                                                                         value = c(2000,as.numeric(format(Sys.Date(), '%Y'))),
                                                                                                                                                                                                                                                         step = 1,sep = ""),
                                                                                                                                                                                                                                      shiny::sliderInput("pm_max",
                                                                                                                                                                                                                                                         "Stop after ... papers:",
                                                                                                                                                                                                                                                         min = 1,
                                                                                                                                                                                                                                                         max = 1000,
                                                                                                                                                                                                                                                         value = 500),
                                                                                                                                                                                                                                      shinyWidgets::circleButton("search_pubmed", icon = shiny::icon("search"), size = "sm"),
                                                                                                                                                                                                                                      shiny::tabsetPanel(selected = 1,
                                                                                                                                                                                                                                                         shiny::tabPanel(title = shiny::icon("cloud"),
                                                                                                                                                                                                                                                                         shiny::conditionalPanel("input.wc_cloudbar_pm == true",
                                                                                                                                                                                                                                                                                                 tagList(
                                                                                                                                                                                                                                                                                                   wordcloud2::wordcloud2Output("wordcloud_desc_pm"),
                                                                                                                                                                                                                                                                                                   shiny::tags$script(HTML(
                                                                                                                                                                                                                                                                                                     "$(document).on('click', '#canvas', function() {",
                                                                                                                                                                                                                                                                                                     'word = document.getElementById("wcSpan").innerHTML;',
                                                                                                                                                                                                                                                                                                     "Shiny.onInputChange('selected_word_desc_pm', word);",
                                                                                                                                                                                                                                                                                                     "});"
                                                                                                                                                                                                                                                                                                   ))
                                                                                                                                                                                                                                                                                                 )),
                                                                                                                                                                                                                                                                         shiny::conditionalPanel("input.wc_cloudbar_pm == false",
                                                                                                                                                                                                                                                                                                 plotly::plotlyOutput("wordbar_desc_pm")
                                                                                                                                                                                                                                                                         ),
                                                                                                                                                                                                                                                                         shiny::sliderInput("wc_topn_pm", "Top words shown:", min = 1,
                                                                                                                                                                                                                                                                                            max = 100, step = 1,value = 30, width = "60%"),
                                                                                                                                                                                                                                                                         MetaboShiny::switchButton("wc_cloudbar_pm", label = "", col = "BW", type = "CLBR",value = F)),
                                                                                                                                                                                                                                                         shiny::tabPanel(title = shiny::icon("table"),
                                                                                                                                                                                                                                                                         shiny::div(DT::dataTableOutput('pm_tab', width="100%"),
                                                                                                                                                                                                                                                                                    style='font-size:80%'))
                                                                                                                                                                                                                                                         )
                                                                                                                                                                                                                                      ))
                                                                                                                                                                                                   )))
                                                                                                                                                      
                                                                                                                                      ),
                                                                                                                                      # reverse searching
                                                                                                                                      shiny::tabPanel(title="molecule > mz",
                                                                                                                                                      shiny::fluidRow(align="center",
                                                                                                                                                                      br(),
                                                                                                                                                                      shiny::tags$i("Press the below button to browse compounds of the selected databases."),br(),
                                                                                                                                                                      shiny::actionButton("browse_db", "Browse", icon=shiny::icon("eye")),
                                                                                                                                                                      br(),
                                                                                                                                                                      shiny::tabsetPanel(
                                                                                                                                                                        shiny::tabPanel(NULL, icon = shiny::icon("database"),
                                                                                                                                                                                        wellPanel(id = "def",style = "overflow-y:scroll; max-height: 200px",
                                                                                                                                                                                                  shiny::textOutput("browse_definition")),
                                                                                                                                                                                        shiny::div(DT::dataTableOutput('browse_tab'),style='font-size:80%'),
                                                                                                                                                                                        br(),
                                                                                                                                                                                        shiny::tags$i("M/z values matching adducts or isotopes of this compound:"),br(),
                                                                                                                                                                                        shiny::div(DT::dataTableOutput('hits_tab'),style='font-size:80%'))
                                                                                                                                                                      ))
                                                                                                                                                      
                                                                                                                                      ))
                                                                                                   ),
                                                                                                   shiny::tabPanel("switch/subset", icon=shiny::icon("exchange")
                                                                                                                   ,shiny::h2("Current experiment:")
                                                                                                                   ,shiny::fluidRow(align="center", 
                                                                                                                                    shiny::div(
                                                                                                                                      MetaboShiny::sardine(shiny::h2(shiny::textOutput("curr_name"),style="padding:10px;")),
                                                                                                                                      style="background-color:white;
                                                                                                                                      height:55px;
                                                                                                                                      width:100%;
                                                                                                                                      margin: 0 auto;
                                                                                                                                      border-top: 1px solid #DFDCDC;
                                                                                                                                      border-bottom: 1px solid #DFDCDC;")
                                                                                                                                    ,shiny::hr()
                                                                                                                                    ,shiny::h2("Change variable of interest")
                                                                                                                                    ,shiny::selectizeInput("stats_type", 
                                                                                                                                                           label = "Normal, two-factor or time series?", 
                                                                                                                                                           choices = list("one factor"="1f", 
                                                                                                                                                                          "two factors"="2f",
                                                                                                                                                                          "time series"="t",
                                                                                                                                                                          "time series + one factor"="t1f"),
                                                                                                                                                           selected = "1f",width = "80%")
                                                                                                                                    ,fluidRow(align="center",shiny::uiOutput("stats_picker"))
                                                                                                                                    ,shiny::conditionalPanel("input.stats_type == '1f'",
                                                                                                                                                             shiny::checkboxInput("paired", 
                                                                                                                                                                                  "Matched samples only?",
                                                                                                                                                                                  value = F))
                                                                                                                                    ,shiny::conditionalPanel("input.stats_type == 't' || input.stats_type == 't1f'",
                                                                                                                                                             shiny::selectizeInput("time_var", 
                                                                                                                                                                                   label="Time series variable:", 
                                                                                                                                                                                   choices = c("label"),width = "80%"))
                                                                                                                                    ,shinyWidgets::circleButton("change_cls", 
                                                                                                                                                                icon = shiny::icon("hand-pointer-o"), 
                                                                                                                                                                size = "sm")
                                                                                                                                    ,shiny::hr()
                                                                                                                                    ,shiny::h2("Subset data")
                                                                                                                                    ,helpText("Current sample count:")
                                                                                                                                    ,h2(shiny::textOutput("samp_count"))
                                                                                                                                    ,br()
                                                                                                                                    ,shiny::selectInput("subset_var", label="Subset data based on:", choices = c("label"),width = "80%")
                                                                                                                                    ,shiny::selectizeInput("subset_group", label="Group(s) in subset:", choices = c(), multiple=TRUE,width = "80%")
                                                                                                                                    ,shinyWidgets::circleButton("change_subset", icon = shiny::icon("hand-pointer-o"), size = "sm")
                                                                                                                                    ,helpText("Reset to non-subsetted or paired dataset")
                                                                                                                                    ,shinyWidgets::circleButton("reset_subset", icon = shiny::icon("undo"), size = "sm"))
                                                                                                                   
                                                                                                                   ),
                                                                                                   # this tab is used to select user plot theme and user colours (discrete and continuous)
                                                                                                   shiny::tabPanel("plot aesthetics", icon=shiny::icon("paint-brush"),
                                                                                                                   shiny::fluidRow(align="center",
                                                                                                                                   shiny::h2("Summary plot style"),br(),
                                                                                                                                   shiny::selectizeInput("ggplot_sum_style", multiple=T, label = "Style(s)", choices = list("Box"="box",
                                                                                                                                                                                                                            "Violin"="violin",
                                                                                                                                                                                                                            "Beeswarm"="beeswarm",
                                                                                                                                                                                                                            "Scatterplot"="scatter"),
                                                                                                                                                         selected = c("beeswarm"),width = "80%"
                                                                                                                                   ),
                                                                                                                                   shiny::selectInput("ggplot_sum_stats", label = "Stats shown", choices = list("median", "mean", "none"),width = "80%"),
                                                                                                                                   shiny::h2("Shape")
                                                                                                                                   ,shiny::selectInput("shape_var", label="Marker shape based on:", choices = c("label"),width = "80%")
                                                                                                                                   ,shiny::h2("Color")
                                                                                                                                   ,shiny::selectInput("col_var", label="Marker color based on:", choices = c("label"),width = "80%")
                                                                                                                                   ,shiny::h2("Hover text")
                                                                                                                                   ,shiny::selectInput("txt_var", label="Marker hover text based on:", choices = c("label"),width = "80%"),
                                                                                                                                   shiny::h2("Plot theme"),
                                                                                                                                   shiny::selectInput("ggplot_theme", label = "Theme", choices = list("Grid, white bg"="bw",
                                                                                                                                                                                                      "No grid, white bg"="classic",
                                                                                                                                                                                                      "Grid, gray bg"="gray",
                                                                                                                                                                                                      "Minimal"="min",
                                                                                                                                                                                                      "Grid, black bg"="dark",
                                                                                                                                                                                                      "Grid, white bg, gray axes"="light",
                                                                                                                                                                                                      "Line drawing"="line"),
                                                                                                                                                      selected = "min",width = "80%"),
                                                                                                                                   shiny::fluidRow(shiny::plotOutput("ggplot_theme_example",inline = F, width="100%")),
                                                                                                                                   shiny::h2("Continuous data"),
                                                                                                                                   # the below options need to match with the corresponding function storage in 'global'. if you want to add more it'll go here!
                                                                                                                                   shiny::selectInput("color_ramp", label = "Color scheme", choices = list("RAINBOW!"="rb",
                                                                                                                                                                                                           "Yellow - blue"="y2b",
                                                                                                                                                                                                           "Matlab 1"="ml1",
                                                                                                                                                                                                           "Matlab 2 "="ml2",
                                                                                                                                                                                                           "Magenta - Green"="m2g",
                                                                                                                                                                                                           "Cyan - yellow"="c2y",
                                                                                                                                                                                                           "Blue - yellow"="b2y",
                                                                                                                                                                                                           "Green - red"="g2r",
                                                                                                                                                                                                           "Blue - green"="b2g",
                                                                                                                                                                                                           "Blue - red"="b2r",
                                                                                                                                                                                                           "Blue - pink (pastel)"="b2p",
                                                                                                                                                                                                           "Blue - green - yellow"="bgy",
                                                                                                                                                                                                           "Green - yellow - white"="gyw",
                                                                                                                                                                                                           "Red - yellow - white"="ryw",
                                                                                                                                                                                                           "Grayscale"="bw",
                                                                                                                                                                                                           "Blues (brew)" = "Blues",
                                                                                                                                                                                                           "Blue - green (brew)" = "BuGn",
                                                                                                                                                                                                           "Blue - purple (brew)" = "BuPu",
                                                                                                                                                                                                           "Green - blue (brew)" = "GnBu",
                                                                                                                                                                                                           "Greens (brew)" = "Greens",
                                                                                                                                                                                                           "Grayscale (brew)" = "Greys",
                                                                                                                                                                                                           "Oranges (brew)" = "Oranges",
                                                                                                                                                                                                           "Orange - red (brew)" = "OrRd",
                                                                                                                                                                                                           "Purple - blue (brew)" = "PuBu",
                                                                                                                                                                                                           "Purple - blue - green (brew)" = "PuBuGn",
                                                                                                                                                                                                           "Purple - red (brew)" = "PuRd",
                                                                                                                                                                                                           "Purples (brew)" = "Purples",
                                                                                                                                                                                                           "Red - purple (brew)" = "RdPu",
                                                                                                                                                                                                           "Reds (brew)" = "Reds",
                                                                                                                                                                                                           "Yellow - green (brew)" = "YlGn",
                                                                                                                                                                                                           "Yellow - green - blue (brew)" = "YlGnBu",
                                                                                                                                                                                                           "Yellow - orange - brown (brew)" = "YlOrBr",
                                                                                                                                                                                                           "Yellow - orange - red (brew)"="YlOrRd",
                                                                                                                                                                                                           "BrBG", "PiYG", "PRGn", "PuOr", "RdBu", #TODO: add descriptions (or remove all?)
                                                                                                                                                                                                           "RdGy", "RdYlBu", "RdYlGn", "Spectral",
                                                                                                                                                                                                           "Accent", "Dark2", "Paired", "Pastel1",
                                                                                                                                                                                                           "Pastel2", "Set1", "Set2", "Set3"),selected = "rainbow",width = "80%"
                                                                                                                                   ),
                                                                                                                                   # preview plot
                                                                                                                                   plotly::plotlyOutput("ramp_plot",inline = T, width="100%"),
                                                                                                                                   shiny::h2("Discrete data"),
                                                                                                                                   shiny::uiOutput("colorPickers")
                                                                                                                   ) # colour pickers generated in server.R. default settings taken from user_options.txt.
                                                                                                   ),
                                                                                                   shiny::tabPanel("metadata",icon = shiny::icon("plus"),
                                                                                                                   shiny::fluidRow(align="center",
                                                                                                                                   br(),br(),
                                                                                                                                   shiny::h2("New metadata"),
                                                                                                                                   shiny::helpText("If you want to update your metadata, please use the below upload screen! 
                                                                                                                                                   Any samples missing in your uploaded csv will be labeled as 'unknown' for new metadata columns."),
                                                                                                                                   shinyFiles::shinyFilesButton('metadata_new', 'upload', 'Select metadata', FALSE),
                                                                                                                                   shinyWidgets::circleButton("metadata_new_add", icon = shiny::icon("arrow-right"))
                                                                                                                   )))
                                                                   )
                                                   )),
                                   
                                   # report tab
                                   #TODO: update to most recent version using orca and re-enable
                                   # shiny::tabPanel("report",
                                   #                 icon = shiny::icon("file-invoice", class = "outlined"),
                                   #                 value="reportTab",
                                   #                 shiny::fluidRow(
                                   #                   shiny::column(width=12, align="center",
                                   #                                 shiny::h2("Report"),
                                   #                                 br(),
                                   #                                 shiny::helpText("Report contents:"),
                                   #                                 shiny::div(DT::dataTableOutput('report_unselected',  width="100%"))
                                   #                   )#close column
                                   #                 )#close fluidrow
                                   #),#close tabpanel
                                   # this tab is used to change general settings.
                                   shiny::tabPanel("settings",  icon = shiny::icon("cog",class = "outlined"), value="options",
                                                   shiny::tabsetPanel(id="tab_settings",
                                                                     shiny::tabPanel("Global", icon=shiny::icon("box-open"),
                                                                                     # MetaboShiny::switchButton(inputId = "db_only", label = "Run in database-only mode?",
                                                                                     #                           value = F,
                                                                                     #                           col = "BW", type = "YN")
                                                                                     shiny::sliderInput("ncores", "How many cores can MetShi use?", value=2, min=1, max = parallel::detectCores() - 1)
                                                                     ),
                                                                     shiny::tabPanel("Project", icon=shiny::icon("gift"),
                                                                                     #shiny::textInput(inputId="proj_name", label="Project name", value = ''),
                                                                                     shiny::selectizeInput(inputId="proj_name",
                                                                                                           label="Project name",
                                                                                                           choices=c("..."), # existing projects in user folder (generated in 'global')
                                                                                                           selected = "...",
                                                                                                           options=list(create = TRUE)), # let users add new names
                                                                                     shiny::actionButton("set_proj_name", label="Apply"),
                                                                                     shiny::helpText("This name will be used in all save files."),
                                                                                     shiny::textOutput("proj_name")
                                                                     ),
                                                                     # change list of adducts used, or add your own
                                                                     # TODO: fix, i think this is currently non-functional
                                                                     shiny::tabPanel("Adducts", icon=shiny::icon("plus-square"),
                                                                                     shiny::tabsetPanel(
                                                                                       shiny::tabPanel("Definitions",
                                                                                                       shiny::h3("Current adduct table:"),
                                                                                                       rhandsontable::rHandsontableOutput("adduct_tab", 
                                                                                                                                          width=800, height=600),
                                                                                                       shiny::fileInput("add_tab", "Import adduct table",
                                                                                                                        multiple = F,
                                                                                                                        accept = c(".RData", ".csv")),
                                                                                                       MetaboShiny::sardine(shiny::actionButton("import_adducts", "Import definitions"))
                                                                                                       ),
                                                                                       shiny::tabPanel("Rules",
                                                                                                       shiny::h3("Current adduct rules:"),
                                                                                                       rhandsontable::rHandsontableOutput("adduct_rules_tab", 
                                                                                                                                          width=800, height=600),
                                                                                                       shiny::fileInput("add_rule_tab", "Import adduct rule table",
                                                                                                                        multiple = F,
                                                                                                                        accept = c(".RData", ".csv")),
                                                                                                       MetaboShiny::sardine(shiny::actionButton("import_adduct_rules", "Import rules"))
                                                                                                       )
                                                                                     ),
                                                                                     shiny::actionButton("save_adducts","Save changes"),
                                                                                     shiny::hr()
                                                                     ),
                                                                     # change toolbar colour, text font and size
                                                                     shiny::tabPanel("Aesthetic", icon=shiny::icon("child"),
                                                                                     shiny::h3("Change app settings"),
                                                                                     shiny::hr(),
                                                                                     shiny::h2("Navigation bar colours"),
                                                                                     colourpicker::colourInput(inputId = "bar.col.1",
                                                                                                               label = paste("Inactive background"),
                                                                                                               #value = opts$col1,
                                                                                                               allowTransparent = FALSE),
                                                                                     colourpicker::colourInput(inputId = "bar.col.2",
                                                                                                               label = paste("Active background"),
                                                                                                               #value = opts$col2,
                                                                                                               allowTransparent = FALSE),
                                                                                     colourpicker::colourInput(inputId = "bar.col.3",
                                                                                                               label = paste("Inactive tab text"),
                                                                                                               #value = opts$col3,
                                                                                                               allowTransparent = FALSE),
                                                                                     colourpicker::colourInput(inputId = "bar.col.4",
                                                                                                               label = paste("Active tab text"),
                                                                                                               #value = opts$col4,
                                                                                                               allowTransparent = FALSE),
                                                                                     shiny::br(),
                                                                                     shiny::a(shiny::h2("Fonts (Google fonts)"), href = "https://fonts.google.com/"),
                                                                                     shiny::textInput(inputId="font.1", label="h1", value = "Leckerli One"),
                                                                                     shiny::textInput(inputId="font.2", label="h2", value = "Leckerli One"),
                                                                                     shiny::textInput(inputId="font.3", label="h3", value = "Open Sans"),
                                                                                     shiny::textInput(inputId="font.4", label="body", value = "Open Sans"),
                                                                                     shiny::br(), # TODO: font size modifier slider
                                                                                     shiny::h2("Font size"),
                                                                                     shiny::sliderInput("size.1", label="h1", value=30,min = 5, max=50),
                                                                                     shiny::sliderInput("size.2", label="h2", value=20,min = 5, max=50),
                                                                                     shiny::sliderInput("size.3", label="h3", value=13,min = 5, max=50),
                                                                                     shiny::sliderInput("size.4", label="body", value=10,min = 5, max=50),
                                                                                     shiny::br(),
                                                                                     shiny::h3("Taskbar image"),
                                                                                     shiny::div(shiny::imageOutput("taskbar_image",inline = T)),
                                                                                     shinyFiles::shinyFilesButton('taskbar_image_path',
                                                                                                                  'Select image',
                                                                                                                  'Please select an image file',
                                                                                                                  FALSE),
                                                                                     shiny::hr(),
                                                                                     shiny::actionButton("change_css", "Save settings (restart to apply)") # need to reload CSS to enable new settings
                                                                     )
                                                   )
                                   ),
                                   # prompt user on opening the quit tab.
                                   # TODO: add 'save project?' dialog
                                   #tabPanel(title = "", value="stop", icon = shiny::icon("times-circle",class = "outlined")),
                                   shiny::div(class="spinnylocation1",
                                              shiny::div(class="plus", img(class="imagetop", 
                                                                           src="gemmy_rainbow.png", 
                                                                           width="80px", height="80px"))
                                   ),
                                   shiny::div(class="line")
                                   ,footer=shiny::fluidRow(
                                     br(),br(),br(),br(),
                                     shiny::div(class = "footer",
                                       #shiny::actionButton("show_window", label="", icon = shiny::icon("map-marked")),
                                       shiny::actionButton("load_mset", label="load", icon = shiny::icon("folder-open")),
                                       shiny::actionButton("save_mset", label="save", icon = shiny::icon("save")),
                                       shiny::actionButton("debug", label="debug", icon = shiny::icon("bug"))
                                       ),
                                     align="center")
                 )
)
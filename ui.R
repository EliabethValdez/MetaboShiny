#TODO: zoom font size

shinyUI(fluidPage(theme = "metaboshiny.css",tags$head(tags$script(src = "sparkle.js"),  # load in javascript and CSS for page in general
                                                      tags$style(type="text/css", bar.css) # load in the user customized css (generated in 'global')
),
ECharts2Shiny::loadEChartsLibrary(),
shinyalert::useShinyalert(), # enable shinyalert (necessary for on close message)
shinyjqui::includeJqueryUI(),
navbarPage(inverse=TRUE,title=div(div(h1("MetaboShiny"),class="outlined"), tags$head(tags$style(type="text/css", font.css)), # load in user customized css (generated in 'global')
                                  class="sparkley"), # make it use the sparkle.js for unnecessary sparkle effects ;)
           id="nav_general",
           windowTitle = "MetaboShiny",
           # this tab shows the currently installed packages.
           # tabPanel("", icon = icon("share-alt",class = c("outlined","fa-2x")), value="setup",
           #          # --- db check cols ---
           #          fluidRow(column(width=2),column(width=8, align="center",
           #                                          h2("Setup"),
           #                                          br(),
           #                                          imageOutput("cute_package",inline = T),
           #                                          hr(),
           #                                          helpText("Installed packages:"),
           #                                          div(DT::dataTableOutput('package_tab',  # table with current packages, should be generated in 'server'
           #                                                                  width="100%"),
           #                                              style='font-size:80%'),
           #                                          br(),
           #                                          actionButton("update_packages", "Install missing packages", icon = icon("heart")),
           #                                          br(),br(),
           #                                          imageOutput("package_check") # generate a checkmark once installing/updating has completed
           #          ))),
           # this tab shows the available databases, if they are installed, and buttons to install them. generated as output$db_build_ui in 'server'
           tabPanel("", icon = icon("database",class = "outlined"), value="database",
                    uiOutput("db_build_ui") %>% shinycssloaders::withSpinner() # see server, is autogenerated now
           ),
           # this tab shows the options for creating a new project, either from 2 csv files and an excel, or from a .db file and an excel.
           tabPanel("", icon = icon("upload",class = "outlined"), value="upload",
                    fluidRow(column(9, align="center",
                                    h2("Create project"))),
                    hr(),
                    tabsetPanel(id="new_proj",selected = "From DB",
                                # first tab is the 'new' method that uses a .db file. generally used for very large projects by powerusers
                                # may want to hide later..
                                tabPanel(id="db", title="From DB",
                                         br(),br(),
                                         fluidRow(
                                           column(3, align="center",
                                                  imageOutput("db_icon", inline = T),
                                                  br(),br()
                                           ),
                                           column(3, align="center",
                                                  br(),br(),
                                                  imageOutput("excel_icon",inline = T)
                                           )
                                         ),
                                         fluidRow(
                                           column(3, align="center",
                                                  shinyFilesButton('database', 'DATABASE', 'Please select an database file', FALSE)
                                           ),
                                           column(3, align="center",
                                                  shinyFilesButton('metadata', 'METADATA', 'Please select a metadata file', FALSE)
                                           )
                                         )
                                ),
                                # second tab is the 'old' method that uses 2 csv files (with columns: "mzmed", "Sample1", "Sample2" etc)
                                tabPanel(id="csv", title="From CSV",
                                         br(),br(),
                                         fluidRow(column(3,  align="center",
                                                         imageOutput("pos_icon",inline = T),
                                                         br(),br(),
                                                         shinyFilesButton('outlist_pos', 'POSITIVE PEAKS', 'Please select a csv file', FALSE)
                                         ),
                                         column(3,  align="center",
                                                imageOutput("excel_icon_2",inline = T),
                                                br(),br(),
                                                shinyFilesButton('metadata', 'METADATA', 'Please select a metadata file', FALSE),
                                                hr(),
                                                sliderInput("ppm",label = "m/z accuracy",
                                                            min = 1, max = 50,
                                                            value = 2, post = " ppm")
                                         ),
                                         column(3,  align="center",
                                                imageOutput("neg_icon",inline = T),
                                                br(),br(),
                                                shinyFilesButton('outlist_neg', 'NEGATIVE PEAKS', 'Please select a csv file', FALSE)
                                         )
                                         )
                                )
                    ),
                    hr(),
                    # contains button to start db creation, mode switches based on tab used entered files in
                    fluidRow( align="center",
                              column(9,
                                    textInput("proj_name_new", label = "Project name:", value = "my_metshi"),
                                    shinyWidgets::circleButton("create_db", "Go", icon = icon("arrow-right"),size = "lg")
                    ))
           ),
           # this tab is used to create a csv file from the database built in the previous tab
           tabPanel("", icon=icon("file-text-o",class = "outlined"), value="document",
                    sidebarLayout(position="left",
                                  sidebarPanel = sidebarPanel(align="center",
                                                              # button to start the csv creation process
                                                              fluidRow(align="center", h3("Generate CSV from database")),
                                                              br(),
                                                              shinyWidgets::circleButton("create_csv", icon=icon("arrow-right"), size = "lg"),
                                                              hr()
                                  ),
                                  # this tab shows a summary of the created/loaded in csv file.
                                  mainPanel = mainPanel(align="center",
                                                        fluidRow(div(DT::dataTableOutput('csv_tab'),style='font-size:80%'))
                                  )
                    )
           ),
           # this tab is used to perform normalization of your data. settings are processed as input$filt_type etc. in 'server'.
           tabPanel("",  icon = icon("shower",class = "outlined"), value="filter",
                    fluidRow(column(3, aligh="center",
                                    selectInput('samp_var', 'Which variable represents sample amount/concentration?', choices = c("")), #TODO: only show this when normalize by sample specific factor (specnorm) is selected
                                    selectizeInput('batch_var', 'What are your batch variables?', choices = c("batch"), multiple=TRUE, options = list(maxItems = 2L)),
                                    actionButton("check_csv", "Get options", icon=icon("refresh")),
                                    hr(),
                                    shinyWidgets::sliderTextInput("perc_limit","Max. missing feature percent:",
                                                                  choices=c(0, 0.0001, 0.001, 0.01, 0.1, seq(1, 100, 1)),
                                                                  selected=1, grid = T),
                                    selectInput('filt_type', 'How will you filter your m/z values?', choices = list("Interquantile range"="iqr",
                                                                                                                    "Relative stdev"="rsd",
                                                                                                                    "Non-parametric relative stdev"="nrsd",
                                                                                                                    "Mean"="mean",
                                                                                                                    "Standard deviation"="sd",
                                                                                                                    "Median absolute deviation"="mad",
                                                                                                                    "Median"="median",
                                                                                                                    "None"="none"),
                                                selected = "none"),
                                    selectInput('norm_type', 'What type of normalization do you want to do?', choices = list("Quantile normalization"="QuantileNorm",
                                                                                                                             "By reference feature"="ProbNorm",
                                                                                                                             "By reference compound"="CompNorm",
                                                                                                                             "By sample specific factor"="SpecNorm",
                                                                                                                             "Sum"="SumNorm",
                                                                                                                             "Median"="MedianNorm",
                                                                                                                             "None"="NULL")),
                                    uiOutput("ref_select"),
                                    selectInput('trans_type', 'How will you transform your data?', choices = list("Log transform"="LogNorm",
                                                                                                                  "Cubic root transform"="CrNorm",
                                                                                                                  "None"="NULL")),
                                    selectInput('scale_type', 'How will you scale your data?', choices = list("Autoscale/Z-transform"="AutoNorm",
                                                                                                              "Mean-center"="MeanCenter",
                                                                                                              "Pareto Scaling"="ParetoNorm",
                                                                                                              "Range scaling"="RangeNorm",
                                                                                                              "None"="NULL")),
                                    selectInput('miss_type', 'How to deal with missing values?', choices = list("Half feature minimum"="colmin",
                                                                                                                "Half sample minimum"="rowmin",
                                                                                                                "Total minimum"="min",
                                                                                                                "Random forest"="rf",
                                                                                                                #"Impute w/ regression"="regr",
                                                                                                                "KNN imputation"="knn",
                                                                                                                "SVD imputation"="svdImpute",
                                                                                                                "BPCA imputation"="bpca",
                                                                                                                "PPCA imputation"="ppca",
                                                                                                                "Median"="median",
                                                                                                                "Mean"="mean",
                                                                                                                "Leave them out"="exclude",
                                                                                                                "Leave them alone"="none"),
                                                selected = "knn"),
                                    switchButton(inputId = "remove_outliers",
                                                 label = "Exclude outliers?",
                                                 value = FALSE, col = "BW", type = "YN"),
                                    actionButton("initialize", "Go", icon=icon("hand-o-right")),
                                    hr(),
                                    imageOutput("dataset_icon",inline = T),
                                    fileInput("pat_dataset", "Import dataset",
                                              multiple = F,
                                              accept = c(".RData")),
                                    actionButton("import_dataset", "Import", icon = icon("hand-peace-o")),
                                    imageOutput("dataset_upload_check",inline = T)
                    ), column(9,
                              # show the summary plots post-normalization
                              navbarPage(inverse=F,h3("explore"),
                                         tabPanel("m/z values",# icon=icon("braille"),
                                                  fluidRow(column(6,plotOutput("var1",height='300px')),
                                                           column(6,plotOutput("var3", height='300px'))
                                                  ),
                                                  fluidRow(column(6,plotOutput("var2", height='500px')),
                                                           column(6,plotOutput("var4", height='500px')))
                                         ),
                                         tabPanel("samples",# icon=icon("tint"),
                                                  fluidRow(column(6,plotOutput("samp1",height='300px')),
                                                           column(6,plotOutput("samp3", height='300px'))
                                                  ),
                                                  fluidRow(column(6,plotOutput("samp2", height='500px')),
                                                           column(6,plotOutput("samp4", height='500px')))
                                         )
                              )
                              )
                    )),
           # this tab is the main analysis tab. all tabs for all analyses are listed here, but the visibility is changed depending on the current experiment
           tabPanel("",  icon = icon("bar-chart",class = "outlined"), value = "analysis",
                    sidebarLayout(position="right",
                                  mainPanel = mainPanel(width = 8,
                                                        tabsetPanel(id="statistics",selected = "pca",
                                                        #navbarPage(inverse=F, "", id="statistics", selected = "pca", collapsible = T,
                                                                   # TODO: T-SNE
                                                                   # this tab shows general information, mostly a message with 'please give me some data' :-)
                                                                   tabPanel(icon("star"), value = "inf",
                                                                            fluidRow(column(width=12, align="center",
                                                                                            br(),br(),br(),br(),
                                                                                            #hr(),
                                                                                            #icon("arrow-right","fa-lg"), icon("arrow-right","fa-lg"), icon("arrow-right","fa-lg"),
                                                                                            br(),br(),
                                                                                            h2("Please select a variable of interest in the sidebar!"),br(),
                                                                                            icon("exchange", "fa-4x"),
                                                                                            br(),br(),br()
                                                                                            #hr()
                                                                                            #icon("arrow-right","fa-lg"), icon("arrow-right","fa-lg"), icon("arrow-right","fa-lg")
                                                                            ))),
                                                                   tabPanel("dimension reduction", value = "dimred",  icon=icon("cube"),
                                                                            navbarPage(inverse=F, icon("cube"), id = "dimred",
                                                                                       # loading this tab performs PCA. summary and loading tables, alongside a 2d/3d PCA plot, are available here.
                                                                                       tabPanel("pca", value = "pca", #icon=icon("cube"),
                                                                                                fluidRow(align="center",column(12,plotly::plotlyOutput("plot_pca",height = "600px", width="600px") %>% shinycssloaders::withSpinner())),
                                                                                                fluidRow(align="center",column(12,
                                                                                                                               switchButton("pca_2d3d", label = "", col = "BW", type = "2d3d"))),
                                                                                                hr(),
                                                                                                fluidRow(column(3,
                                                                                                                selectInput("pca_x", label = "X axis:", choices = paste0("PC",1:20),selected = "PC1",width="100%"),
                                                                                                                selectInput("pca_y", label = "Y axis:", choices = paste0("PC",1:20),selected = "PC2",width="100%"),
                                                                                                                selectInput("pca_z", label = "Z axis:", choices = paste0("PC",1:20),selected = "PC3",width="100%")),
                                                                                                         column(9,
                                                                                                                tabsetPanel(id="pca_2",
                                                                                                                            tabPanel(title="Table",
                                                                                                                                     div(DT::dataTableOutput('pca_tab',width="100%"),style='font-size:80%')),
                                                                                                                            tabPanel(title="Scree",
                                                                                                                                     plotOutput("pca_scree")
                                                                                                                            ),
                                                                                                                            tabPanel(title="Loadings",
                                                                                                                                     div(DT::dataTableOutput('pca_load_tab',width="100%"),style='font-size:80%'))
                                                                                                                ))
                                                                                                )
                                                                                       ),
                                                                                       # TODO: enable the sparse and orthogonal PLS-DA options in metaboanalystR
                                                                                       # this tab is used to perform pls-da. it triggers on 'go' button as it is a time costly analysis.
                                                                                       tabPanel("pls-da", value = "plsda",
                                                                                                fluidRow(align="center",column(12,plotly::plotlyOutput("plot_plsda",height = "500px", width="500px"))),
                                                                                                fluidRow(align="center",column(12,
                                                                                                                               switchButton("plsda_2d3d", label = "", col = "BW", type = "2d3d"))),
                                                                                                hr(),
                                                                                                fluidRow(column(3,
                                                                                                                div(style="display:inline-block",
                                                                                                                    selectInput("plsda_type",
                                                                                                                                label="Type:",
                                                                                                                                choices=list("Normal"="normal")
                                                                                                                                #,
                                                                                                                                #             "Orthogonal"="ortho",
                                                                                                                                #             "Sparse"="sparse")
                                                                                                                                ,width = '100px',
                                                                                                                                selected=1)),
                                                                                                                div(style="display:inline-block",
                                                                                                                    shinyWidgets::circleButton("do_plsda", icon = icon("hand-pointer-o"), size = "sm")
                                                                                                                ),
                                                                                                                selectInput("plsda_x", label = "X axis:", choices = paste0("PC",1:8),selected = "PC1",width="100%"),
                                                                                                                selectInput("plsda_y", label = "Y axis:", choices = paste0("PC",1:8),selected = "PC2",width="100%"),
                                                                                                                selectInput("plsda_z", label = "Z axis:", choices = paste0("PC",1:8),selected = "PC3",width="100%")),
                                                                                                         column(9,
                                                                                                                tabsetPanel(id="plsda_2",
                                                                                                                            tabPanel(title="Cross-validation",
                                                                                                                                     plotOutput("plsda_cv_plot")),
                                                                                                                            tabPanel(title="Permutation",
                                                                                                                                     plotOutput("plsda_perm_plot")),
                                                                                                                            tabPanel(title="Table",
                                                                                                                                     div(DT::dataTableOutput('plsda_tab',width="100%"),style='font-size:80%')),
                                                                                                                            tabPanel(title="Loadings",
                                                                                                                                     div(DT::dataTableOutput('plsda_load_tab',width="100%"),style='font-size:80%'))
                                                                                                                ))
                                                                                                )
                                                                                       ),
                                                                                       tabPanel("t-sne", value = "tsne",
                                                                                           helpText("working on it")
                                                                                       )
                                                                   )),
                                                                   tabPanel("per m/z", value = "permz", icon=icon("fingerprint"),
                                                                            navbarPage(inverse=F, icon("fingerprint"), id = "permz",
                                                                                       tabPanel("t-test", value="tt",
                                                                                                fluidRow(plotly::plotlyOutput('tt_specific_plot',width="100%")),
                                                                                                fluidRow(align="center",
                                                                                                         sardine(switchButton("tt_nonpar", "Non-parametric?", col="BW", type="YN", value = T)),
                                                                                                         #sardine(uiOutput("tt_parbutton")),
                                                                                                         sardine(switchButton("tt_eqvar", "Equal variance?", col="BW", type="YN", value = T))
                                                                                                ),
                                                                                                navbarPage(inverse=F,"",
                                                                                                           tabPanel("", icon=icon("table"),
                                                                                                                    div(DT::dataTableOutput('tt_tab',width="100%"),style='font-size:80%'))
                                                                                                           ,tabPanel("", icon=icon("area-chart"),
                                                                                                                     plotly::plotlyOutput('tt_overview_plot',height="300px") %>% shinycssloaders::withSpinner()
                                                                                                           )
                                                                                                )),
                                                                                       tabPanel("anova", value="aov",
                                                                                                fluidRow(plotly::plotlyOutput('aov_specific_plot',width="100%")),
                                                                                                navbarPage(inverse=F,"",
                                                                                                           tabPanel("", icon=icon("table"),
                                                                                                                    div(DT::dataTableOutput('aov_tab',width="100%"),style='font-size:80%'))
                                                                                                           ,tabPanel("", icon=icon("area-chart"),
                                                                                                                     plotly::plotlyOutput('aov_overview_plot',height="300px") %>% shinycssloaders::withSpinner()
                                                                                                           )
                                                                                                )),
                                                                                       tabPanel("fold-change", value="fc",
                                                                                                fluidRow(plotly::plotlyOutput('fc_specific_plot',width="100%")),
                                                                                                navbarPage(inverse=F,"",
                                                                                                           tabPanel("", icon=icon("table"),
                                                                                                                    div(DT::dataTableOutput('fc_tab',width="100%"),style='font-size:80%'))
                                                                                                           ,tabPanel("", icon=icon("area-chart"),
                                                                                                                     plotly::plotlyOutput('fc_overview_plot',height="300px") %>% shinycssloaders::withSpinner()
                                                                                                           ))
                                                                                       ),
                                                                                       tabPanel("meba", value="meba",
                                                                                                fluidRow(plotly::plotlyOutput('meba_specific_plot',height="600px")),
                                                                                                fluidRow(div(DT::dataTableOutput('meba_tab', width="100%"),style='font-size:80%'))
                                                                                       ),
                                                                                       tabPanel("asca", value="asca",
                                                                                                fluidRow(plotly::plotlyOutput('asca_specific_plot', height="600px")),
                                                                                                fluidRow(div(DT::dataTableOutput('asca_tab',width="100%"),style='font-size:80%'))
                                                                                       )
                                                                                       )
                                                                            ),
                                                                   tabPanel("overview analyses", value = "overview", icon=icon("globe"),
                                                                            navbarPage(inverse=F, icon("globe"), id = "overview",
                                                                                       tabPanel("volcano plot", value="volc",
                                                                                                fluidRow(plotly::plotlyOutput('volc_plot',width="100%",height="600px") %>% shinycssloaders::withSpinner()),
                                                                                                fluidRow(div(DT::dataTableOutput('volc_tab',width="100%"),style='font-size:80%'))
                                                                                       ),
                                                                                       tabPanel("heatmap", value="heatmap",
                                                                                                plotly::plotlyOutput("heatmap",width="100%",height="700px") %>% shinycssloaders::withSpinner(),
                                                                                                br(),
                                                                                                fluidRow(column(align="center",
                                                                                                                width=12,
                                                                                                                sliderInput("heatmap_topn", "Use top ... from table:", value=100, min = 10, max = 200))
                                                                                                ),
                                                                                                fluidRow(column(align="center",
                                                                                                                width=12,
                                                                                                                uiOutput("heatbutton"),
                                                                                                                switchButton("heatsign", label = "Only significant hits?", col = "GB", type = "YN"),
                                                                                                                switchButton("heatlimits", label = "Color based on -all- metabolites?", col = "GB", type = "YN")
                                                                                                ))
                                                                                       )
                                                                            )
                                                                   ),
                                                                   # this tab enables machine learning
                                                                   tabPanel("machine learning", value = "ml", icon=icon("signature"),
                                                                            br(),
                                                                            navbarPage(inverse=F, icon("signature"), id = "ml",
                                                                                       tabPanel("initialize", value="init",
                                                                                                fluidRow(
                                                                                                  column(width=3,align="center",
                                                                                                         selectInput("ml_perf_metr", label=h2("Performance metric"),
                                                                                                                     choices = c("boot", "boot632", "optimism_boot",
                                                                                                                                 "boot_all", "cv", "repeatedcv",
                                                                                                                                 "LOOCV", "LGOCV", "none", "oob",
                                                                                                                                 "timeslice", "addaptive_cv", "adaptive_boot",
                                                                                                                                 "adaptive_LGOCV"),
                                                                                                                     multiple = F, selected = "repeatedcv"),
                                                                                                         sliderInput("ml_train_perc",
                                                                                                                     label = h2("Percentage in training"),
                                                                                                                     min = 1,
                                                                                                                     max = 100,
                                                                                                                     step = 1,
                                                                                                                     value = 60,
                                                                                                                     post = "%"),
                                                                                                         selectInput("ml_folds", label=h2("Fold CV"),choices = c("5",
                                                                                                                                                                 "10",
                                                                                                                                                                 "20",
                                                                                                                                                                 "50",
                                                                                                                                                                 "LOOCV"),
                                                                                                                     multiple = F),
                                                                                                         sliderInput("ml_attempts",
                                                                                                                     label = "Attempts",
                                                                                                                     min = 1,
                                                                                                                     max = 100,
                                                                                                                     step = 1,
                                                                                                                     value = 20,
                                                                                                                     post = "x"),
                                                                                                         # - - - - - - - - - -
                                                                                                         style="z-index:1002;"
                                                                                                  ),
                                                                                                  column(width=6,align="center",
                                                                                                         selectInput("ml_method",
                                                                                                                     label = h2("Used algorithm"),
                                                                                                                     selected = "glmnet",
                                                                                                                     choices = {
                                                                                                                       lst = as.list(global$constants$ml.models)
                                                                                                                       # names(lst) <- sapply(global$constants$ml.models, function(mdl) caret.mdls[[mdl]]$label)
                                                                                                                       lst
                                                                                                                     },
                                                                                                                     multiple = F),
                                                                                                         div(uiOutput("ml_params"), style = "font-size:60%"),
                                                                                                         selectizeInput("ml_preproc", label = h2("Data reprocessing"),
                                                                                                                        choices = c("center", "scale"),
                                                                                                                        selected = c("center", "scale"), multiple=T),
                                                                                                         shinyWidgets::circleButton("do_ml",
                                                                                                                                    icon = h3(paste("Go"),
                                                                                                                                              icon("hand-pointer-o", "fa-lg")),
                                                                                                                                    status = "default",
                                                                                                                                    size = "lg"),
                                                                                                         style="z-index:1003;"
                                                                                                  ),
                                                                                                  column(width=3,align="center",
                                                                                                         fluidRow(textOutput("ml_train_ss"),
                                                                                                                  actionButton("ml_train_ss", label = "train on:", icon = icon("arrow-up"))),
                                                                                                         fluidRow(textOutput("ml_test_ss"),
                                                                                                                  actionButton("ml_test_ss", label = "test on:", icon = icon("arrow-up"))),
                                                                                                         br(),
                                                                                                         textInput("ml_name", label=h3("Name:"), value = "all"))
                                                                                                )
                                                                                                ),
                                                                                       tabPanel("results", value="res", icon=icon("poll"),
                                                                                                br(),
                                                                                                div(selectInput("show_which_ml", label = "Plot which model?", choices = c())),
                                                                                                navbarPage(title=icon("poll"),id="ml_results",inverse=F,
                                                                                                           tabPanel(title = "roc",value = "roc",icon=icon("area-chart"),
                                                                                                                    plotlyOutput("ml_roc",height = "600px"),
                                                                                                                    div(DT::dataTableOutput("ml_tab",width="100%"),style='font-size:80%')),
                                                                                                           tabPanel("importance",value= "bar",icon=icon("star"),
                                                                                                                    fluidRow(plotlyOutput("ml_bar", width = "100%", height="600px")),
                                                                                                                    fluidRow(
                                                                                                                      column(12, sliderInput("ml_top_x",
                                                                                                                                             label = "Show top:",
                                                                                                                                             min = 10,
                                                                                                                                             max = 200,
                                                                                                                                             step=10,
                                                                                                                                             value=20), align="center")
                                                                                                                    )
                                                                                                           )
                                                                                                )
                                                                                       )
                                                                                       )
                                                                   ),
                                                                   # this tab is used to find overlapping features of interest between analyses
                                                                   # TODO: enable this with multiple saved mSets in mSet$storage
                                                                   tabPanel(title="venn diagrams", value="venn", icon=icon("comments"),
                                                                            sidebarLayout(position = "left",
                                                                                          sidebarPanel = sidebarPanel(
                                                                                            fluidRow(div(DT::dataTableOutput('venn_unselected'),style='font-size:80%'), align="center"),
                                                                                            fluidRow(shinyWidgets::circleButton("venn_add", icon=icon("arrow-down"), size="sm"),
                                                                                                     shinyWidgets::circleButton("venn_remove", icon=icon("arrow-up"), size="sm"),
                                                                                                     align="center"),
                                                                                            fluidRow(div(DT::dataTableOutput('venn_selected'),style='font-size:80%'),align="center"),
                                                                                            hr(),
                                                                                            fluidRow(
                                                                                              sliderInput("venn_tophits", label = "Only include top:", min = 1, max = 200, post = " hits", value=20)
                                                                                              ,align="center"),
                                                                                            fluidRow(
                                                                                              shinyWidgets::circleButton("venn_build", icon=icon("hand-pointer-o"),size="default")
                                                                                              ,align="center")
                                                                                          ),
                                                                                          mainPanel = mainPanel(
                                                                                            hr(),
                                                                                            plotOutput("venn_plot",inline = F),
                                                                                            # find the overlapping compounds between the groups you want to compare (user select)
                                                                                            # TODO: enable this with clicking the numbers/areas
                                                                                            fluidRow(selectInput("intersect_venn", label = "Show hits from (only):", selected = 1,choices = "",multiple = T),
                                                                                                     align="center"),
                                                                                            fluidRow(uiOutput("venn_pval"), align="center"),
                                                                                            br(),
                                                                                            fluidRow(div(DT::dataTableOutput('venn_tab'),style='font-size:80%'),
                                                                                                     align="center")
                                                                                          ))
                                                                   )
                                                        )
                                  ),
                                  # this is the sidebar that shows in the analysis tab. contains a lot of settings on the current variable of interest, plot themes and colours, and venn diagrams.
                                  sidebarPanel =
                                    sidebarPanel(align="center",width = 4,
                                                 tabsetPanel(id = "search", #type = "pills",
                                                             tabPanel(title=NULL, icon=icon("search"),
                                                                      br(),
                                                                      bsCollapse(bsCollapsePanel(title=h2("Settings"), style="info",
                                                                                                 tabsetPanel(id="tab_iden_1", selected = "start",
                                                                                                             # forward searching
                                                                                                             tabPanel(title=icon("database"),value="start",
                                                                                                                      uiOutput("db_search_select"),
                                                                                                                      div(id = "curly-brace", div(id = "left", class = "brace"),
                                                                                                                          div(id = "right", class = "brace")),
                                                                                                                      br(),br(),
                                                                                                                      shinyWidgets::circleButton("select_db_all",
                                                                                                                                                 icon = icon("shopping-cart"),
                                                                                                                                                 size = "default") # icon("fingerprint"), size = "sm")
                                                                                                             ), # clicky buttons for database selection; this is generated in 'server'
                                                                                                             tabPanel(title=icon("chart-bar"),
                                                                                                                      plotly::plotlyOutput("curr_plot", height="300px", width="100%") %>% shinycssloaders::withSpinner()
                                                                                                             ),
                                                                                                             tabPanel(title=icon("magic"),
                                                                                                                      h2("MagicBall settings"),
                                                                                                                      fluidRow(align="center",switchButton(inputId = "magicball_pubchem_cids",
                                                                                                                                                           label = "Check PubChem for predicted formulas?",
                                                                                                                                                           col = "BW", type = "YN", value = F)
                                                                                                                      ),
                                                                                                                      fluidRow(align="center",switchButton(inputId = "magicball_pubchem_details",
                                                                                                                                                           label = "Get detailed PubChem matches? (SLOW!)",
                                                                                                                                                           col = "BW", type = "YN", value = F)
                                                                                                                      ),
                                                                                                                      fluidRow(align="center", helpText("Calculated adducts..")),

                                                                                                                      fluidRow(div(DT::dataTableOutput('magicball_add_tab'),style='font-size:60%'),
                                                                                                                               align="center")
                                                                                                                      ),
                                                                                                             tabPanel(title=icon("star-half-alt"),
                                                                                                                      selectInput("iso_score_method",
                                                                                                                                  "Which method used to score compounds of same weight?",
                                                                                                                                  selected="mscore",
                                                                                                                                  choices=list("M-score"="mscore"
                                                                                                                                               #"Chi-square"="chisq",
                                                                                                                                               #"Mean absolute percentage error"="mape",
                                                                                                                                               #"SIRIUS"="sirius",
                                                                                                                                               #"Network-based"="network"
                                                                                                                                  )),
                                                                                                                      sliderInput("int_prec", label = "Intensity imprecision", min = 1, max = 100, value = 2, post = "%"),
                                                                                                                      shinyWidgets::circleButton("score_iso", icon = icon("award"), size = "sm") # icon("fingerprint"), size = "sm")
                                                                                                             )
                                                                                                 ))),
                                                                      tabsetPanel(id="tab_iden_2",
                                                                                  # forward searching
                                                                                  tabPanel(title="mz > molecule",
                                                                                           hr(),
                                                                                           fluidRow(
                                                                                             tags$button(
                                                                                               id = "search_cpd",
                                                                                               class = "btn btn-default action-button",
                                                                                               img(src = "detective.png",
                                                                                                   height = "50px")
                                                                                             ),
                                                                                             div(
                                                                                               sardine(div(icon("paw","fa-xs fa-rotate-90"),
                                                                                                           style="position:relative;
                                                                                                           top:10px;")),
                                                                                               sardine(div(icon("paw","fa-xs fa-rotate-90"),
                                                                                                           style="position:relative;
                                                                                                           top:25px;")),
                                                                                               sardine(div(icon("paw","fa-xs fa-rotate-90"),
                                                                                                           style="position:relative;
                                                                                                           top:10px;")),
                                                                                               sardine(h2(textOutput("curr_cpd"),style="padding:10px;")),
                                                                                               sardine(div(icon("paw","fa-xs fa-rotate-90"),
                                                                                                           style="position:relative;
                                                                                                           top:10px;")),
                                                                                               sardine(div(icon("paw","fa-xs fa-rotate-90"),
                                                                                                           style="position:relative;
                                                                                                           top:25px;")),
                                                                                               sardine(div(icon("paw","fa-xs fa-rotate-90"),
                                                                                                           style="position:relative;
                                                                                                           top:10px;")),
                                                                                               style="background-color:white;
                                                                                               height:55px;
                                                                                               width:115%;
                                                                                               position:relative;
                                                                                               right:30px;
                                                                                               border-top: 1px solid #DFDCDC;
                                                                                               border-bottom: 1px solid #DFDCDC;")
                                                                                               ),
                                                                                           bsCollapse(bsCollapsePanel(title=h2("Compound info"), style="warning",
                                                                                                                      tabsetPanel(id="tab_iden_3",
                                                                                                                                  tabPanel(title=icon("atlas"),
                                                                                                                                           wellPanel(id = "def",style = "overflow-y:scroll; max-height: 200px",
                                                                                                                                                     textOutput("curr_definition"))
                                                                                                                                  ),
                                                                                                                                  tabPanel(title=icon("atom"),
                                                                                                                                           textOutput("curr_formula"),
                                                                                                                                           plotOutput("curr_struct", height="300px")
                                                                                                                                  )
                                                                                                                      ))),
                                                                                           bsCollapse(bsCollapsePanel(title=h2("Search results"), style="error",
                                                                                                                      tabsetPanel(id="tab_iden_4",selected = "start",
                                                                                                                                  # forward searching
                                                                                                                                  tabPanel(title=icon("table"), value="start",
                                                                                                                                           div(DT::dataTableOutput('match_tab', width="100%"),style='font-size:80%'),
                                                                                                                                           hr(),
                                                                                                                                           fluidRow(
                                                                                                                                             switchButton(inputId = "auto_copy",
                                                                                                                                                          label = "Auto-copy name to clipboard??",
                                                                                                                                                          value = TRUE, col = "GB", type = "YN"),
                                                                                                                                             align="center"),
                                                                                                                                           helpText("Undo filtering"),
                                                                                                                                           fluidRow(
                                                                                                                                             shinyWidgets::circleButton("undo_match_filt", icon = icon("undo-alt"), size = "sm") # icon("fingerprint"), size = "sm")
                                                                                                                                           )
                                                                                                                                  ),
                                                                                                                                  tabPanel(title=icon("database"), value="pie_db",
                                                                                                                                           fluidRow(align = "center",
                                                                                                                                                    plotly::plotlyOutput("match_pie_db") %>% shinycssloaders::withSpinner()
                                                                                                                                           )
                                                                                                                                  ),
                                                                                                                                  tabPanel(title=icon("plus"), value = "pie_add",
                                                                                                                                           fluidRow(align = "center",
                                                                                                                                                    plotly::plotlyOutput("match_pie_add") %>% shinycssloaders::withSpinner()
                                                                                                                                           )
                                                                                                                                  ),
                                                                                                                                  tabPanel(title=icon("cloud"), value = "word_cloud",
                                                                                                                                           fluidRow(align = "center",
                                                                                                                                                    list(
                                                                                                                                                      wordcloud2::wordcloud2Output("wordcloud_desc") %>% shinycssloaders::withSpinner(),
                                                                                                                                                      tags$script(HTML(
                                                                                                                                                        "$(document).on('click', '#canvas', function() {",
                                                                                                                                                        'word = document.getElementById("wcSpan").innerHTML;',
                                                                                                                                                        "Shiny.onInputChange('selected_word_desc', word);",
                                                                                                                                                        "});"
                                                                                                                                                      )))
                                                                                                                                           )
                                                                                                                                  ),
                                                                                                                                  tabPanel(title=icon("searchengin"),
                                                                                                                                           textInput('pm_query', "Search for:"),
                                                                                                                                           sliderInput('pm_year', "Paper publication range:",
                                                                                                                                                       min = 1900, max = as.numeric(format(Sys.Date(), '%Y')),
                                                                                                                                                       value = c(2000,as.numeric(format(Sys.Date(), '%Y'))),
                                                                                                                                                       step = 1,sep = ""
                                                                                                                                           ),
                                                                                                                                           sliderInput("pm_max",
                                                                                                                                                       "Stop after ... papers:",
                                                                                                                                                       min = 1,
                                                                                                                                                       max = 1000,
                                                                                                                                                       value = 500),
                                                                                                                                           shinyWidgets::circleButton("search_pubmed", icon = icon("search"), size = "sm"),
                                                                                                                                           tabsetPanel(selected = 1,
                                                                                                                                                       tabPanel(title = icon("cloud"),
                                                                                                                                                                wordcloud2::wordcloud2Output("wordcloud_pubmed") %>% shinycssloaders::withSpinner(),
                                                                                                                                                                tags$script(HTML(
                                                                                                                                                                  "$(document).on('click', '#canvas', function() {",
                                                                                                                                                                  'word = document.getElementById("wcSpan").innerHTML;',
                                                                                                                                                                  "Shiny.onInputChange('selected_word_pubmed', word);",
                                                                                                                                                                  "});"
                                                                                                                                                                ))
                                                                                                                                                       ),
                                                                                                                                                       tabPanel(title = icon("table"),
                                                                                                                                                                div(DT::dataTableOutput('pm_tab', width="100%"),style='font-size:80%')
                                                                                                                                                       )
                                                                                                                                           )

                                                                                                                                  )
                                                                                                                      )))

                                                                                               ),
                                                                                  # reverse searching
                                                                                  tabPanel(title="molecule > mz",
                                                                                           br(),
                                                                                           actionButton("browse_db", "Browse compounds", icon=icon("eye")),
                                                                                           hr(),
                                                                                           tabsetPanel(
                                                                                             tabPanel(NULL, icon = icon("database"),
                                                                                                      wellPanel(id = "def",style = "overflow-y:scroll; max-height: 200px",
                                                                                                                textOutput("browse_definition")),
                                                                                                      div(DT::dataTableOutput('browse_tab'),style='font-size:80%'),
                                                                                                      hr(),
                                                                                                      actionButton("revsearch_cpd", "Find hits", icon=icon("search"))
                                                                                                      ),
                                                                                             tabPanel(NULL, icon = icon("search-location"),
                                                                                                      div(DT::dataTableOutput('hits_tab'),style='font-size:80%')
                                                                                                      )
                                                                                           )

                                                                                  ))
                                                                                               ),
                                                             tabPanel(NULL, icon=icon("exchange")
                                                                      ,h2("Current experiment:")
                                                                      ,div(
                                                                        sardine(h2(textOutput("curr_name"),style="padding:10px;")),
                                                                        style="background-color:white;
                                                                        height:55px;
                                                                        width:115%;
                                                                        position:relative;
                                                                        right:30px;
                                                                        border-top: 1px solid #DFDCDC;
                                                                        border-bottom: 1px solid #DFDCDC;")
                                                                      ,hr()
                                                                      ,h2("Change variable of interest")
                                                                      ,selectInput("stats_var", label="Do statistics on:", choices = c("label"))
                                                                      ,shinyWidgets::circleButton("change_cls", icon = icon("hand-pointer-o"), size = "sm")
                                                                      ,fluidRow(column(12, align="center", uiOutput("timebutton")))
                                                                      ,hr()
                                                                      ,h2("Subset data")
                                                                      ,selectInput("subset_var", label="Subset data based on:", choices = c("label"))
                                                                      ,selectizeInput("subset_group", label="Group(s) in subset:", choices = c(), multiple=TRUE)
                                                                      ,shinyWidgets::circleButton("change_subset", icon = icon("hand-pointer-o"), size = "sm")
                                                                      ,shinyWidgets::circleButton("reset_subset", icon = icon("undo"), size = "sm")

                                                                      ),
                                                             # this tab is used to select user plot theme and user colours (discrete and continuous)
                                                             tabPanel(NULL, icon=icon("paint-brush"),
                                                                      h2("Summary plot style"),br(),
                                                                      selectizeInput("ggplot_sum_style", multiple=T, label = "Style(s)", choices = list("Box"="box",
                                                                                                                                                        "Violin"="violin",
                                                                                                                                                        "Beeswarm"="beeswarm",
                                                                                                                                                        "Scatterplot"="scatter"),
                                                                                     selected = c("violin")
                                                                      ),
                                                                      selectInput("ggplot_sum_stats", label = "Stats shown", choices = list("median", "mean", "none")),
                                                                      h2("Shape")
                                                                      ,selectInput("shape_var", label="Marker shape based on:", choices = c("label"))
                                                                      ,h2("Color")
                                                                      ,selectInput("col_var", label="Marker color based on:", choices = c("label"))
                                                                      ,h2("Hover text")
                                                                      ,selectInput("txt_var", label="Marker hover text based on:", choices = c("label")),
                                                                      h2("Plot theme"),
                                                                      selectInput("ggplot_theme", label = "Theme", choices = list("Grid, white bg"="bw",
                                                                                                                                  "No grid, white bg"="classic",
                                                                                                                                  "Grid, gray bg"="gray",
                                                                                                                                  "Minimal"="min",
                                                                                                                                  "Grid, black bg"="dark",
                                                                                                                                  "Grid, white bg, gray axes"="light",
                                                                                                                                  "Line drawing"="line"),
                                                                                  selected = getOptions()$gtheme),
                                                                      fluidRow(plotOutput("ggplot_theme_example",inline = F, width="100%")),
                                                                      h2("Continuous data"),
                                                                      # the below options need to match with the corresponding function storage in 'global'. if you want to add more it'll go here!
                                                                      selectInput("color_ramp", label = "Color scheme", choices = list("RAINBOW!"="rb",
                                                                                                                                       "Yellow - blue"="y2b",
                                                                                                                                       "Matlab 1"="ml1",
                                                                                                                                       "Matlab 2 "="ml2",
                                                                                                                                       "Magenta - Green"="m2g",
                                                                                                                                       "Cyan - yellow"="c2y",
                                                                                                                                       "Blue - yellow"="b2y",
                                                                                                                                       "Green - red"="g2r",
                                                                                                                                       "Blue - green"="b2g",
                                                                                                                                       "Blue - red"="b2r",
                                                                                                                                       "Blue - pink (pastel)"="b2p",
                                                                                                                                       "Blue - green - yellow"="bgy",
                                                                                                                                       "Green - yellow - white"="gyw",
                                                                                                                                       "Red - yellow - white"="ryw",
                                                                                                                                       "Grayscale"="bw",
                                                                                                                                       "Blues (brew)" = "Blues",
                                                                                                                                       "Blue - green (brew)" = "BuGn",
                                                                                                                                       "Blue - purple (brew)" = "BuPu",
                                                                                                                                       "Green - blue (brew)" = "GnBu",
                                                                                                                                       "Greens (brew)" = "Greens",
                                                                                                                                       "Grayscale (brew)" = "Greys",
                                                                                                                                       "Oranges (brew)" = "Oranges",
                                                                                                                                       "Orange - red (brew)" = "OrRd",
                                                                                                                                       "Purple - blue (brew)" = "PuBu",
                                                                                                                                       "Purple - blue - green (brew)" = "PuBuGn",
                                                                                                                                       "Purple - red (brew)" = "PuRd",
                                                                                                                                       "Purples (brew)" = "Purples",
                                                                                                                                       "Red - purple (brew)" = "RdPu",
                                                                                                                                       "Reds (brew)" = "Reds",
                                                                                                                                       "Yellow - green (brew)" = "YlGn",
                                                                                                                                       "Yellow - green - blue (brew)" = "YlGnBu",
                                                                                                                                       "Yellow - orange - brown (brew)" = "YlOrBr",
                                                                                                                                       "Yellow - orange - red (brew)"="YlOrRd",
                                                                                                                                       "BrBG", "PiYG", "PRGn", "PuOr", "RdBu", #TODO: add descriptions (or remove all?)
                                                                                                                                       "RdGy", "RdYlBu", "RdYlGn", "Spectral",
                                                                                                                                       "Accent", "Dark2", "Paired", "Pastel1",
                                                                                                                                       "Pastel2", "Set1", "Set2", "Set3"),selected = getOptions()$gspec
                                                                      ),
                                                                      # preview plot
                                                                      fluidRow(plotly::plotlyOutput("ramp_plot",inline = T, width="100%") %>% shinycssloaders::withSpinner()),
                                                                      h2("Discrete data"),
                                                                      uiOutput("colorPickers") # colour pickers generated in server.R. default settings taken from user_options.txt.
                                                             ))
                                    )
                    )),

           # report tab
           tabPanel("",
                    icon = icon("file-invoice", class = "outlined"),
                    value="reportTab",
                    fluidRow(
                      column(width=12, align="center",
                             h2("Report"),
                             br(),
                             helpText("Report contents:"),
                             div(DT::dataTableOutput('report_unselected',  width="100%"))
                      )#close column
                    )#close fluidrow
           ),#close tabpanel

           # this tab is used to change general settings.
           tabPanel("",  icon = icon("cog",class = "outlined"), value="options",
                    navbarPage(inverse=TRUE,"Settings", id="tab_settings",
                               tabPanel("Project", icon=icon("gift"),
                                        #textInput(inputId="proj_name", label="Project name", value = ''),
                                        selectizeInput(inputId="proj_name",
                                                       label="Project name",
                                                       choices=global$vectors$project_names, # existing projects in user folder (generated in 'global')
                                                       selected = getOptions()$proj_name,
                                                       options=list(create = TRUE)), # let users add new names
                                        actionButton("set_proj_name", label="Apply"),
                                        helpText("This name will be used in all save files."),
                                        textOutput("proj_name")
                               ),
                               # user directory picking
                               tabPanel("Storage", icon=icon("folder-open-o"),
                                        shinyDirButton("get_db_dir", "Choose a database directory" ,
                                                       title = "Browse",
                                                       buttonType = "default", class = NULL),
                                        helpText("Your databases will be stored here. 500GB recommended for all (without pubchem ±3GB)"),
                                        textOutput("curr_db_dir"),
                                        hr(),
                                        shinyDirButton("get_work_dir", "Choose a working directory" ,
                                                       title = "Browse",
                                                       buttonType = "default", class = NULL),
                                        helpText("Your results will be stored here for later access."),
                                        textOutput("curr_exp_dir")
                               ),
                               # change list of adducts used, or add your own
                               # TODO: fix, i think this is currently non-functional
                               tabPanel("Adducts", icon=icon("plus-square"),
                                        h3("Current adduct table:"),
                                        rhandsontable::rHandsontableOutput("adduct_tab", width=800, height=600),
                                        shinySaveButton("save_adducts",
                                                        "Save changed table",
                                                        "Save file as ...",
                                                        filetype=list(RData="RData", csv="csv")
                                        ),
                                        hr(),
                                        fileInput("add_tab", "Import adduct table",
                                                  multiple = F,
                                                  accept = c(".RData", ".csv")),
                                        sardine(actionButton("import_adducts", "Import", icon = icon("hand-peace-o"))),
                                        sardine(imageOutput("adduct_upload_check",inline = T))
                               ),
                               # change toolbar colour, text font and size
                               tabPanel("Aesthetic", icon=icon("child"),
                                        h3("Change app settings"),
                                        hr(),
                                        h2("Navigation bar colours"),
                                        colourpicker::colourInput(inputId = "bar.col.1",
                                                                  label = paste("Active background"),
                                                                  value = options$col1,
                                                                  allowTransparent = FALSE),
                                        colourpicker::colourInput(inputId = "bar.col.2",
                                                                  label = paste("Inactive background"),
                                                                  value = options$col2,
                                                                  allowTransparent = FALSE),
                                        colourpicker::colourInput(inputId = "bar.col.3",
                                                                  label = paste("Active tab"),
                                                                  value = options$col3,
                                                                  allowTransparent = FALSE),
                                        colourpicker::colourInput(inputId = "bar.col.4",
                                                                  label = paste("Inactive tab"),
                                                                  value = options$col4,
                                                                  allowTransparent = FALSE),
                                        br(),
                                        h2("Fonts (Google fonts)"),
                                        textInput(inputId="font.1", label="h1", value = options$font1),
                                        textInput(inputId="font.2", label="h2", value = options$font2),
                                        textInput(inputId="font.3", label="h3", value = options$font3),
                                        textInput(inputId="font.4", label="body", value = options$font4),
                                        br(), # TODO: font size modifier slider
                                        h2("Font size"),
                                        sliderInput("size.1", label="h1", value=as.numeric(options$size1),min = 5, max=50),
                                        sliderInput("size.2", label="h2", value=as.numeric(options$size2),min = 5, max=50),
                                        sliderInput("size.3", label="h3", value=as.numeric(options$size3),min = 5, max=50),
                                        sliderInput("size.4", label="body", value=as.numeric(options$size4),min = 5, max=50),
                                        br(),
                                        h3("Taskbar image"),
                                        div(imageOutput("taskbar_image",inline = T)),
                                        shinyFilesButton('taskbar_image_path',
                                                         'Select image',
                                                         'Please select an image file',
                                                         FALSE),
                                        hr(),
                                        actionButton("change_css", "Save settings (restart to apply)") # need to reload CSS to enable new settings
                               )
                    )
           ),
           # prompt user on opening the quit tab.
           # TODO: add 'save project?' dialog
           tabPanel(title = "", value="stop", icon = icon("times-circle",class = "outlined")),
           div(class="spinnylocation1",
               div(class="plus", img(class="imagetop", src=getOptions()$taskbar_image, width="120px", height="120px")),
               div(class="minus", img(class="imagebottom", src=getOptions()$taskbar_image, width="120px", height="120px"))
           ),
           div(class="line")
           ,footer=fluidRow(hr(),
                            actionButton("show_window", label="", icon = icon("map-marked")),
                            actionButton("save_mset", label="", icon = icon("save")),
                            align="center")
                                                                      )
                    )
)
